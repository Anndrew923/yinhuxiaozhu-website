<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上環境診斷工具 | 隱湖小竹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .env-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .env-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .env-card.error {
            border-left-color: #dc3545;
        }
        .env-card.success {
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>線上環境診斷工具</h1>
        <div id="status" class="status info">準備診斷線上環境問題...</div>
        
        <div>
            <button class="btn btn-primary" onclick="runFullDiagnostic()">執行完整診斷</button>
            <button class="btn btn-warning" onclick="testFirebase()">測試 Firebase</button>
            <button class="btn btn-success" onclick="testMenuLoading()">測試菜單載入</button>
            <button class="btn btn-danger" onclick="clearCache()">清除快取</button>
        </div>
        
        <div class="env-info" id="envInfo">
            <!-- 環境資訊將在這裡顯示 -->
        </div>
        
        <div class="test-section">
            <h3>環境資訊</h3>
            <div id="environmentInfo" class="log-area"></div>
        </div>
        
        <div class="test-section">
            <h3>Firebase 連線測試</h3>
            <div id="firebaseTest" class="log-area"></div>
        </div>
        
        <div class="test-section">
            <h3>菜單載入測試</h3>
            <div id="menuTest" class="log-area"></div>
        </div>
        
        <div class="test-section">
            <h3>網路請求測試</h3>
            <div id="networkTest" class="log-area"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/services/auth.service.js"></script>
    <script src="js/services/product.service.js"></script>

    <script>
        let diagnosticLog = '';

        function log(message, area = 'general') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            diagnosticLog += logMessage;
            
            const areaElement = document.getElementById(area + 'Test') || document.getElementById(area + 'Info');
            if (areaElement) {
                areaElement.textContent += logMessage;
                areaElement.scrollTop = areaElement.scrollHeight;
            }
            
            console.log(`[${area.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateEnvInfo() {
            const envInfo = document.getElementById('envInfo');
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' || 
                           window.location.protocol === 'file:';
            
            envInfo.innerHTML = `
                <div class="env-card ${isLocal ? 'warning' : 'success'}">
                    <strong>環境類型</strong><br>
                    ${isLocal ? '本地開發' : '線上生產'}
                </div>
                <div class="env-card">
                    <strong>協議</strong><br>
                    ${window.location.protocol}
                </div>
                <div class="env-card">
                    <strong>主機名</strong><br>
                    ${window.location.hostname}
                </div>
                <div class="env-card">
                    <strong>完整 URL</strong><br>
                    ${window.location.href}
                </div>
                <div class="env-card">
                    <strong>用戶代理</strong><br>
                    ${navigator.userAgent.substring(0, 50)}...
                </div>
                <div class="env-card">
                    <strong>螢幕解析度</strong><br>
                    ${screen.width}x${screen.height}
                </div>
            `;
        }

        async function runFullDiagnostic() {
            diagnosticLog = '';
            updateStatus('開始執行完整診斷...', 'info');
            
            // 清空所有日誌區域
            document.querySelectorAll('.log-area').forEach(area => {
                area.textContent = '';
            });
            
            log('=== 開始完整診斷 ===', 'environment');
            updateEnvInfo();
            
            // 測試環境資訊
            await testEnvironment();
            
            // 測試 Firebase
            await testFirebase();
            
            // 測試菜單載入
            await testMenuLoading();
            
            // 測試網路請求
            await testNetworkRequests();
            
            log('=== 診斷完成 ===', 'environment');
            updateStatus('診斷完成，請查看下方詳細資訊', 'success');
        }

        async function testEnvironment() {
            log('檢查環境資訊...', 'environment');
            
            const env = {
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                port: window.location.port,
                pathname: window.location.pathname,
                search: window.location.search,
                hash: window.location.hash,
                userAgent: navigator.userAgent,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                platform: navigator.platform,
                vendor: navigator.vendor
            };
            
            log('環境資訊:', 'environment');
            Object.entries(env).forEach(([key, value]) => {
                log(`  ${key}: ${value}`, 'environment');
            });
            
            // 檢查是否為本地環境
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' || 
                           window.location.protocol === 'file:';
            
            if (isLocal) {
                log('⚠️ 檢測到本地環境，某些功能可能受限', 'environment');
            } else {
                log('✅ 檢測到線上環境', 'environment');
            }
        }

        async function testFirebase() {
            log('開始測試 Firebase 連線...', 'firebase');
            
            try {
                // 檢查 Firebase 是否已初始化
                if (typeof firebase === 'undefined') {
                    log('❌ Firebase 未載入', 'firebase');
                    return;
                }
                
                log('✅ Firebase 已載入', 'firebase');
                log(`專案 ID: ${firebase.app().options.projectId}`, 'firebase');
                
                // 測試 Firestore 連線
                const db = firebase.firestore();
                log('嘗試連線 Firestore...', 'firebase');
                
                const testDoc = await db.collection('test').doc('connection').get();
                log('✅ Firestore 連線成功', 'firebase');
                
                // 測試認證
                const auth = firebase.auth();
                log('檢查認證狀態...', 'firebase');
                
                const user = auth.currentUser;
                if (user) {
                    log(`✅ 已登入: ${user.email}`, 'firebase');
                } else {
                    log('ℹ️ 未登入', 'firebase');
                }
                
            } catch (error) {
                log(`❌ Firebase 測試失敗: ${error.message}`, 'firebase');
                log(`錯誤詳情: ${error.stack}`, 'firebase');
            }
        }

        async function testMenuLoading() {
            log('開始測試菜單載入...', 'menu');
            
            try {
                // 檢查 ProductService 是否可用
                if (typeof ProductService === 'undefined') {
                    log('❌ ProductService 未載入', 'menu');
                    return;
                }
                
                log('✅ ProductService 已載入', 'menu');
                
                // 測試獲取商品
                log('嘗試獲取商品列表...', 'menu');
                const products = await ProductService.getAllProducts();
                
                log(`✅ 成功獲取 ${products.length} 個商品`, 'menu');
                
                if (products.length > 0) {
                    log('商品列表:', 'menu');
                    products.forEach((product, index) => {
                        log(`  ${index + 1}. ${product.name} (${product.category})`, 'menu');
                    });
                } else {
                    log('ℹ️ 目前沒有商品', 'menu');
                }
                
                // 測試分類篩選
                log('測試分類篩選...', 'menu');
                const noodleProducts = await ProductService.getAllProducts({ category: '麵食' });
                const drinkProducts = await ProductService.getAllProducts({ category: '飲品' });
                
                log(`麵食商品: ${noodleProducts.length} 個`, 'menu');
                log(`飲品商品: ${drinkProducts.length} 個`, 'menu');
                
            } catch (error) {
                log(`❌ 菜單載入測試失敗: ${error.message}`, 'menu');
                log(`錯誤詳情: ${error.stack}`, 'menu');
            }
        }

        async function testNetworkRequests() {
            log('開始測試網路請求...', 'network');
            
            try {
                // 測試基本網路連線
                log('測試網路連線...', 'network');
                
                const testUrls = [
                    'https://www.google.com',
                    'https://firebase.google.com',
                    window.location.origin
                ];
                
                for (const url of testUrls) {
                    try {
                        const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                        log(`✅ ${url} - 連線正常`, 'network');
                    } catch (error) {
                        log(`❌ ${url} - 連線失敗: ${error.message}`, 'network');
                    }
                }
                
                // 測試 CORS
                log('測試 CORS 設定...', 'network');
                try {
                    const corsTest = await fetch('https://httpbin.org/get');
                    log('✅ CORS 測試通過', 'network');
                } catch (error) {
                    log(`⚠️ CORS 測試失敗: ${error.message}`, 'network');
                }
                
            } catch (error) {
                log(`❌ 網路測試失敗: ${error.message}`, 'network');
            }
        }

        async function clearCache() {
            log('嘗試清除快取...', 'environment');
            
            try {
                // 清除 localStorage
                localStorage.clear();
                log('✅ localStorage 已清除', 'environment');
                
                // 清除 sessionStorage
                sessionStorage.clear();
                log('✅ sessionStorage 已清除', 'environment');
                
                // 嘗試清除快取
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                    }
                    log(`✅ 已清除 ${cacheNames.length} 個快取`, 'environment');
                }
                
                updateStatus('快取清除完成，請重新整理頁面', 'success');
                
            } catch (error) {
                log(`❌ 清除快取失敗: ${error.message}`, 'environment');
                updateStatus('清除快取失敗', 'error');
            }
        }

        // 頁面載入時自動執行基本診斷
        document.addEventListener('DOMContentLoaded', function() {
            console.log('線上環境診斷工具載入完成');
            updateEnvInfo();
            log('診斷工具已載入', 'environment');
        });
    </script>
</body>
</html> 