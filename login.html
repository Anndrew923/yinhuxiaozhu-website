<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>會員登入 | 隱湖小竹</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="background-images.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* 登入頁面專用樣式 */
      body {
        background: #f8f9fa;
        margin: 0;
        padding: 0;
        font-family: "Noto Sans TC", sans-serif;
      }

      .login-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .logo-section {
        text-align: center;
        margin: 20px 0;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .logo-placeholder {
        width: 240px;
        height: 240px;
        border-radius: 50%;
        margin: 0 auto 30px;
        display: block; /* 改為block，避免flex可能造成的問題 */
        box-shadow: 0 8px 25px rgba(45, 90, 39, 0.3);
        border: 3px solid white; /* 稍微調整邊框，配合您的logo設計 */
        overflow: hidden; /* 確保圖片不會超出圓形邊界 */
        background: #2d5a27; /* 深綠色背景 */
        position: relative; /* 添加定位 */
      }

      .logo-placeholder img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* 改回cover，確保圖片填滿容器 */
        border-radius: 50%;
        background: #2d5a27; /* 深綠色背景，配合您的logo設計 */
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        .logo-placeholder {
          width: 200px;
          height: 200px;
        }
      }

      @media (max-width: 480px) {
        .logo-placeholder {
          width: 160px;
          height: 160px;
        }
      }

      .login-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2d5a27;
        margin: 0 0 10px 0;
      }

      .login-subtitle {
        font-size: 1rem;
        color: #6c757d;
        margin: 0 0 30px 0;
        line-height: 1.5;
      }

      .form-section {
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-input {
        width: 100%;
        padding: 18px 20px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1.1rem;
        background: white;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .form-input:focus {
        outline: none;
        border-color: #2d5a27;
        box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.1);
      }

      .separator {
        position: relative;
        text-align: center;
        margin: 30px 0;
      }

      .separator::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e9ecef;
      }

      .separator span {
        background: #f8f9fa;
        padding: 0 20px;
        color: #6c757d;
        font-size: 0.9rem;
      }

      .social-login {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-bottom: 30px;
      }

      .social-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid #e9ecef;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.5rem;
        position: relative;
        overflow: hidden;
      }

      .social-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .social-btn.google {
        background: linear-gradient(
          135deg,
          #4285f4 0%,
          #34a853 50%,
          #fbbc05 75%,
          #ea4335 100%
        );
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
      }

      .social-btn.google:hover {
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
      }

      .social-btn.facebook {
        background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(24, 119, 242, 0.3);
      }

      .social-btn.facebook:hover {
        box-shadow: 0 6px 20px rgba(24, 119, 242, 0.4);
      }

      .social-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(255, 255, 255, 0.2) 50%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .social-btn:hover::before {
        opacity: 1;
      }

      .social-icon {
        font-size: 1.8rem;
        font-weight: bold;
        position: relative;
        z-index: 1;
      }

      .login-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #2d5a27 0%, #4a7c59 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(45, 90, 39, 0.3);
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(45, 90, 39, 0.4);
      }

      .register-section {
        text-align: center;
        margin-top: 25px;
      }

      .register-text {
        color: #6c757d;
        font-size: 0.95rem;
      }

      .register-text a {
        color: #2d5a27;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
      }

      .register-text a:hover {
        text-decoration: underline;
      }

      .error-message {
        color: #dc3545;
        text-align: center;
        margin: 15px 0;
        font-size: 0.9rem;
        padding: 10px;
        background: #f8d7da;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
      }

      .success-message {
        color: #155724;
        text-align: center;
        margin: 15px 0;
        font-size: 0.9rem;
        padding: 10px;
        background: #d4edda;
        border-radius: 8px;
        border: 1px solid #c3e6cb;
      }

      /* 隱私保護提醒樣式 */
      .privacy-notice {
        margin: 20px 0;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .privacy-notice-content h4 {
        color: #2d5a27;
        margin: 0 0 12px 0;
        font-size: 1rem;
        font-weight: 600;
      }

      .privacy-notice-content ul {
        margin: 0 0 12px 0;
        padding-left: 20px;
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .privacy-notice-content li {
        margin-bottom: 6px;
      }

      .privacy-link {
        margin: 0;
        text-align: center;
      }

      .privacy-link a {
        color: #4a7c59;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .privacy-link a:hover {
        text-decoration: underline;
      }

      /* Google 登入隱私承諾樣式 */
      .google-privacy-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .google-privacy-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .google-privacy-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 450px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(20px);
        transition: transform 0.3s ease;
      }

      .google-privacy-modal.show .google-privacy-content {
        transform: translateY(0);
      }

      .google-privacy-content h3 {
        color: #2d5a27;
        margin: 0 0 20px 0;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .google-privacy-content .google-icon {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #4285f4;
      }

      .google-privacy-content p {
        color: #495057;
        margin: 0 0 20px 0;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .google-privacy-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .google-privacy-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
      }

      .google-privacy-btn.primary {
        background: #4285f4;
        color: white;
      }

      .google-privacy-btn.primary:hover {
        background: #3367d6;
        transform: translateY(-2px);
      }

      .google-privacy-btn.secondary {
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
      }

      .google-privacy-btn.secondary:hover {
        background: #e9ecef;
      }
    </style>
  </head>
  <body class="login-page">
    <div class="login-container">
      <!-- Logo 區域 -->
      <div class="logo-section">
        <div class="logo-placeholder">
          <img src="assets/logo.png" alt="隱湖小竹 Logo" />
        </div>
        <h1 class="login-title">會員登入</h1>
        <p class="login-subtitle" id="formSubtitle">請輸入您的電子郵件與密碼</p>

        <!-- 隱私保護提醒 -->
        <div class="privacy-notice" id="privacyNotice" style="display: none">
          <div class="privacy-notice-content">
            <h4>🔒 資料安全承諾</h4>
            <ul>
              <li>
                您的個人資料使用 Google Firebase 安全儲存，符合國際安全標準
              </li>
              <li>所有資料傳輸都經過 HTTPS 加密保護</li>
              <li>我們絕不會將您的資料出售或分享給第三方</li>
              <li>您可以隨時在會員中心查看、修改或刪除您的資料</li>
            </ul>
            <p class="privacy-link">
              <a href="privacy-policy.html" target="_blank"
                >查看完整隱私權政策</a
              >
            </p>
          </div>
        </div>
      </div>

      <!-- 登入表單 -->
      <div id="loginForm" class="form-section">
        <div class="form-group">
          <input
            type="email"
            class="form-input"
            placeholder="電子郵件"
            id="loginEmail"
            required
          />
        </div>
        <div class="form-group">
          <input
            type="password"
            class="form-input"
            placeholder="密碼"
            id="loginPassword"
            required
          />
        </div>
      </div>

      <!-- 註冊表單 (預設隱藏) -->
      <div id="registerForm" class="form-section" style="display: none">
        <div class="form-group">
          <input
            type="text"
            class="form-input"
            placeholder="姓名"
            id="registerName"
            required
          />
        </div>
        <div class="form-group">
          <input
            type="tel"
            class="form-input"
            placeholder="手機號碼"
            id="registerPhone"
            maxlength="10"
            required
          />
        </div>
        <div class="form-group">
          <input
            type="email"
            class="form-input"
            placeholder="電子郵件"
            id="registerEmail"
            required
          />
        </div>
        <div class="form-group">
          <input
            type="password"
            class="form-input"
            placeholder="密碼"
            id="registerPassword"
            required
          />
        </div>
      </div>

      <!-- 主按鈕 -->
      <button class="login-btn" id="mainActionBtn">登入</button>

      <!-- 分隔線 -->
      <div class="separator">
        <span>或</span>
      </div>

      <!-- 社群登入 -->
      <div class="social-login">
        <div class="social-btn google" id="googleLogin">
          <span class="social-icon">G</span>
        </div>
        <div class="social-btn facebook" id="facebookLogin">
          <span class="social-icon">f</span>
        </div>
      </div>

      <!-- 切換連結 -->
      <div class="register-section">
        <p class="register-text">
          <span id="toggleText">還沒有帳號？</span>
          <a href="#" id="toggleLink">立即註冊</a>
        </p>
      </div>

      <!-- 錯誤/成功訊息 -->
      <div id="errorMsg" class="error-message" style="display: none"></div>
      <div id="successMsg" class="success-message" style="display: none"></div>
    </div>

    <!-- Google 登入隱私承諾模態框 -->
    <div id="googlePrivacyModal" class="google-privacy-modal">
      <div class="google-privacy-content">
        <div class="google-icon">🔒</div>
        <h3>Google 登入隱私承諾</h3>
        <p>
          我們重視您的隱私安全。使用 Google
          登入時，我們只會取得您的基本資料（姓名、電子郵件）， 並使用 Google
          Firebase 安全儲存，符合國際安全標準。
        </p>
        <p>
          <strong>我們承諾：</strong><br />
          • 絕不會將您的資料出售或分享給第三方<br />
          • 所有資料傳輸都經過 HTTPS 加密保護<br />
          • 您可以隨時在會員中心管理您的資料
        </p>
        <div class="google-privacy-buttons">
          <button
            class="google-privacy-btn secondary"
            onclick="hideGooglePrivacyNotice()"
          >
            取消
          </button>
          <button
            class="google-privacy-btn primary"
            onclick="proceedWithGoogleLogin()"
          >
            同意並繼續
          </button>
        </div>
      </div>
    </div>

    <!-- Facebook 登入隱私承諾模態框 -->
    <div id="facebookPrivacyModal" class="google-privacy-modal">
      <div class="google-privacy-content">
        <div class="google-icon">🔒</div>
        <h3>Facebook 登入隱私承諾</h3>
        <p>
          我們重視您的隱私安全。使用 Facebook
          登入時，我們只會取得您的基本資料（姓名、電子郵件）， 並使用 Google
          Firebase 安全儲存，符合國際安全標準。
        </p>
        <p>
          <strong>我們承諾：</strong><br />
          • 絕不會將您的資料出售或分享給第三方<br />
          • 所有資料傳輸都經過 HTTPS 加密保護<br />
          • 您可以隨時在會員中心管理您的資料
        </p>
        <div class="google-privacy-buttons">
          <button
            class="google-privacy-btn secondary"
            onclick="hideFacebookPrivacyNotice()"
          >
            取消
          </button>
          <button
            class="google-privacy-btn primary"
            onclick="proceedWithFacebookLogin()"
          >
            同意並繼續
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/services/auth.service.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const mainActionBtn = document.getElementById("mainActionBtn");
        const toggleLink = document.getElementById("toggleLink");
        const toggleText = document.getElementById("toggleText");
        const formSubtitle = document.getElementById("formSubtitle");
        const loginTitle = document.querySelector(".login-title");

        const errorMsg = document.getElementById("errorMsg");
        const successMsg = document.getElementById("successMsg");

        let isLoginMode = true;

        // 檢查 URL 參數，如果 action=signup 則自動切換到註冊模式
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("action") === "signup") {
          isLoginMode = false;
          // 自動切換到註冊模式
          loginTitle.textContent = "會員註冊";
          formSubtitle.textContent = "請填寫以下資料以建立帳戶";
          loginForm.style.display = "none";
          registerForm.style.display = "block";
          document.querySelector(".social-login").style.display = "none";
          document.querySelector(".separator").style.display = "none";
          mainActionBtn.textContent = "註冊";
          toggleText.textContent = "已經有帳號？";
          toggleLink.textContent = "立即登入";
          // 顯示隱私保護提醒
          document.getElementById("privacyNotice").style.display = "block";
        }

        toggleLink.addEventListener("click", (e) => {
          e.preventDefault();
          isLoginMode = !isLoginMode;

          if (isLoginMode) {
            loginTitle.textContent = "會員登入";
            formSubtitle.textContent = "請輸入您的電子郵件與密碼";
            loginForm.style.display = "block";
            registerForm.style.display = "none";
            document.querySelector(".social-login").style.display = "flex";
            document.querySelector(".separator").style.display = "block";
            mainActionBtn.textContent = "登入";
            toggleText.textContent = "還沒有帳號？";
            toggleLink.textContent = "立即註冊";
            // 隱藏隱私保護提醒
            document.getElementById("privacyNotice").style.display = "none";
          } else {
            loginTitle.textContent = "會員註冊";
            formSubtitle.textContent = "請填寫以下資料以建立帳戶";
            loginForm.style.display = "none";
            registerForm.style.display = "block";
            document.querySelector(".social-login").style.display = "none";
            document.querySelector(".separator").style.display = "none";
            mainActionBtn.textContent = "註冊";
            toggleText.textContent = "已經有帳號？";
            toggleLink.textContent = "立即登入";
            // 顯示隱私保護提醒
            document.getElementById("privacyNotice").style.display = "block";
          }
          errorMsg.style.display = "none";
          successMsg.style.display = "none";
        });

        mainActionBtn.addEventListener("click", async () => {
          errorMsg.style.display = "none";
          successMsg.style.display = "none";

          if (isLoginMode) {
            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;

            if (!email || !password) {
              showError("請填寫電子郵件與密碼");
              return;
            }

            try {
              await AuthService.signIn(email, password);
              showSuccess("登入成功！正在跳轉...");
              setTimeout(() => {
                window.location.href = "member.html";
              }, 1500);
            } catch (err) {
              console.error("登入失敗:", err);
              showError("登入失敗：" + err.message);
            }
          } else {
            const name = document.getElementById("registerName").value.trim();
            const phone = document.getElementById("registerPhone").value.trim();
            const email = document.getElementById("registerEmail").value.trim();
            const password = document.getElementById("registerPassword").value;

            if (!name || !phone || !email || !password) {
              showError("請填寫所有欄位");
              return;
            }
            if (phone.length !== 10) {
              showError("請輸入正確的手機號碼（10位數字）");
              return;
            }
            if (password.length < 6) {
              showError("密碼長度至少需要 6 個字元");
              return;
            }

            try {
              await AuthService.signUp(email, password, name, phone);
              const backupData = { name, phone, email };
              sessionStorage.setItem(
                "pending_user_data",
                JSON.stringify(backupData)
              );

              showSuccess("註冊成功！正在跳轉...");
              setTimeout(() => {
                window.location.href = "member.html";
              }, 1500);
            } catch (err) {
              console.error("註冊失敗:", err);
              showError("註冊失敗：" + err.message);
            }
          }
        });

        function showError(message) {
          errorMsg.textContent = message;
          errorMsg.style.display = "block";
        }

        function showSuccess(message) {
          successMsg.textContent = message;
          successMsg.style.display = "block";
        }

        // Google 隱私承諾相關函數
        function showGooglePrivacyNotice() {
          const modal = document.getElementById("googlePrivacyModal");
          modal.classList.add("show");

          // 點擊外部關閉
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              hideGooglePrivacyNotice();
            }
          });
        }

        function hideGooglePrivacyNotice() {
          const modal = document.getElementById("googlePrivacyModal");
          modal.classList.remove("show");
        }

        async function proceedWithGoogleLogin() {
          try {
            hideGooglePrivacyNotice();
            showSuccess("正在使用 Google 登入...");
            await AuthService.signInWithGoogle();
            showSuccess("Google 登入成功！正在跳轉...");
            setTimeout(() => {
              window.location.href = "member.html";
            }, 1500);
          } catch (err) {
            console.error("Google 登入失敗:", err);
            showError("Google 登入失敗：" + err.message);
          }
        }

        // Facebook 隱私承諾相關函數
        function showFacebookPrivacyNotice() {
          const modal = document.getElementById("facebookPrivacyModal");
          modal.classList.add("show");

          // 點擊外部關閉
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              hideFacebookPrivacyNotice();
            }
          });
        }

        function hideFacebookPrivacyNotice() {
          const modal = document.getElementById("facebookPrivacyModal");
          modal.classList.remove("show");
        }

        async function proceedWithFacebookLogin() {
          try {
            hideFacebookPrivacyNotice();
            showSuccess("正在使用 Facebook 登入...");
            await AuthService.signInWithFacebook();
            showSuccess("Facebook 登入成功！正在跳轉...");
            setTimeout(() => {
              window.location.href = "member.html";
            }, 1500);
          } catch (err) {
            console.error("Facebook 登入失敗:", err);
            showError("Facebook 登入失敗：" + err.message);
          }
        }

        // 將函數暴露到全域作用域，讓 HTML 中的 onclick 可以調用
        window.hideGooglePrivacyNotice = hideGooglePrivacyNotice;
        window.proceedWithGoogleLogin = proceedWithGoogleLogin;
        window.hideFacebookPrivacyNotice = hideFacebookPrivacyNotice;
        window.proceedWithFacebookLogin = proceedWithFacebookLogin;

        document.getElementById("googleLogin").addEventListener("click", () => {
          // 顯示 Google 登入隱私承諾
          showGooglePrivacyNotice();
        });
        document
          .getElementById("facebookLogin")
          .addEventListener("click", () => {
            // 顯示 Facebook 登入隱私承諾
            showFacebookPrivacyNotice();
          });
        // 電話號碼自動格式化
        const phoneInput = document.getElementById("registerPhone");
        phoneInput.addEventListener("input", (e) => {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 0) {
            value = value.replace(/(\d{4})(\d{3})(\d{3})/, "$1-$2-$3");
          }
          e.target.value = value;
        });
      });
    </script>
  </body>
</html>
