<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿé©—è­‰æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.success:hover {
            background: #229954;
        }

        .result {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background: #27ae60;
        }

        .result.error {
            background: #e74c3c;
        }

        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .product-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .product-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .product-sort {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å¿«é€Ÿé©—è­‰æ¸¬è©¦</h1>
            <p>é©—è­‰ä¿®æ­£å¾Œçš„æ’åºé‚è¼¯æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª æ’åºé‚è¼¯æ¸¬è©¦</h2>
            <button class="btn" onclick="testSortingLogic()">æ¸¬è©¦æ’åºç®—æ³•</button>
            <button class="btn" onclick="testDataConsistency()">æ¸¬è©¦æ•¸æ“šä¸€è‡´æ€§</button>
            <button class="btn success" onclick="runFullVerification()">åŸ·è¡Œå®Œæ•´é©—è­‰</button>
            <div id="sortingResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“¦ å•†å“æ•¸æ“šæ¸¬è©¦</h2>
            <button class="btn" onclick="loadAndDisplayProducts()">è¼‰å…¥å•†å“æ•¸æ“š</button>
            <button class="btn" onclick="createTestProducts()">å‰µå»ºæ¸¬è©¦å•†å“</button>
            <div id="productResult" class="result" style="display: none;"></div>
            <div id="productList" class="product-list" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”„ åŒæ­¥æ¸¬è©¦</h2>
            <button class="btn" onclick="testSync()">æ¸¬è©¦åŒæ­¥</button>
            <div id="syncResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- æœ¬åœ°é…ç½®å’Œæœå‹™ -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/services/admin-product.service.js"></script>

    <script>
        function log(message, type = 'info', containerId = 'sortingResult') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            container.style.display = 'block';
        }

        // æ¸¬è©¦æ’åºé‚è¼¯
        function testSortingLogic() {
            const container = document.getElementById('sortingResult');
            container.innerHTML = '';
            container.className = 'result';

            log('é–‹å§‹æ¸¬è©¦æ’åºé‚è¼¯...', 'info');

            // æ¸¬è©¦æ•¸æ“š
            const testData = [
                { name: 'å•†å“A', sortOrder: 3 },
                { name: 'å•†å“B', sortOrder: 1 },
                { name: 'å•†å“C', sortOrder: 2 },
                { name: 'å•†å“D', sortOrder: null },
                { name: 'å•†å“E', sortOrder: undefined },
                { name: 'å•†å“F', sortOrder: 0 }
            ];

            // æ¸¬è©¦ order.js æ’åºé‚è¼¯
            const orderJsSorted = [...testData].sort((a, b) => {
                const aValue = a.sortOrder || 999;
                const bValue = b.sortOrder || 999;
                return aValue - bValue;
            });

            // æ¸¬è©¦ AdminProductService æ’åºé‚è¼¯
            const adminServiceSorted = [...testData].sort((a, b) => {
                let aValue = a.sortOrder || 999;
                let bValue = b.sortOrder || 999;
                
                // ç¢ºä¿æ•¸å­—é¡å‹æ­£ç¢ºæ¯”è¼ƒ
                if (typeof aValue === 'number' && typeof bValue === 'number') {
                    return aValue - bValue;
                }
                
                return aValue > bValue ? 1 : -1;
            });

            // é©—è­‰çµæœ
            const expectedOrder = ['å•†å“F', 'å•†å“B', 'å•†å“C', 'å•†å“A', 'å•†å“D', 'å•†å“E'];
            const orderJsOrder = orderJsSorted.map(p => p.name);
            const adminServiceOrder = adminServiceSorted.map(p => p.name);

            log('æ¸¬è©¦çµæœ:', 'info');
            log(`æœŸæœ›é †åº: ${expectedOrder.join(' â†’ ')}`, 'info');
            log(`order.js é †åº: ${orderJsOrder.join(' â†’ ')}`, 'info');
            log(`AdminService é †åº: ${adminServiceOrder.join(' â†’ ')}`, 'info');

            const orderJsCorrect = JSON.stringify(orderJsOrder) === JSON.stringify(expectedOrder);
            const adminServiceCorrect = JSON.stringify(adminServiceOrder) === JSON.stringify(expectedOrder);

            if (orderJsCorrect && adminServiceCorrect) {
                log('âœ… æ’åºé‚è¼¯æ¸¬è©¦é€šéï¼å…©å€‹æ’åºç®—æ³•çµæœä¸€è‡´', 'success');
                container.className = 'result success';
            } else {
                log('âŒ æ’åºé‚è¼¯æ¸¬è©¦å¤±æ•—ï¼æ’åºçµæœä¸ä¸€è‡´', 'error');
                container.className = 'result error';
            }
        }

        // æ¸¬è©¦æ•¸æ“šä¸€è‡´æ€§
        async function testDataConsistency() {
            const container = document.getElementById('sortingResult');
            container.innerHTML = '';
            container.className = 'result';

            log('é–‹å§‹æ¸¬è©¦æ•¸æ“šä¸€è‡´æ€§...', 'info');

            try {
                // ä½¿ç”¨ order.js é‚è¼¯
                const db = firebase.firestore();
                const snapshot = await db.collection("products").get();
                
                const orderJsProducts = [];
                snapshot.forEach((doc) => {
                    const productData = doc.data();
                    if (productData.status === "active") {
                        orderJsProducts.push({
                            id: doc.id,
                            ...productData,
                        });
                    }
                });

                orderJsProducts.sort((a, b) => {
                    const aValue = a.sortOrder || 999;
                    const bValue = b.sortOrder || 999;
                    return aValue - bValue;
                });

                // ä½¿ç”¨ AdminProductService
                const result = await AdminProductService.getProducts({
                    status: 'active',
                    sortBy: 'sortOrder',
                    sortOrder: 'asc'
                });

                const adminServiceProducts = result.products;

                log(`æ•¸æ“šè¼‰å…¥å®Œæˆ:`, 'info');
                log(`order.js: ${orderJsProducts.length} å€‹å•†å“`, 'info');
                log(`AdminService: ${adminServiceProducts.length} å€‹å•†å“`, 'info');

                // æ¯”è¼ƒçµæœ
                if (orderJsProducts.length === adminServiceProducts.length) {
                    let isConsistent = true;
                    for (let i = 0; i < orderJsProducts.length; i++) {
                        if (orderJsProducts[i].id !== adminServiceProducts[i].id) {
                            isConsistent = false;
                            log(`âŒ ç¬¬ ${i + 1} ä½ä¸ä¸€è‡´: ${orderJsProducts[i].name} vs ${adminServiceProducts[i].name}`, 'error');
                        }
                    }

                    if (isConsistent) {
                        log('âœ… æ•¸æ“šä¸€è‡´æ€§æ¸¬è©¦é€šéï¼å…©å€‹æ–¹æ³•è¿”å›ç›¸åŒçš„æ’åºçµæœ', 'success');
                        container.className = 'result success';
                    } else {
                        log('âŒ æ•¸æ“šä¸€è‡´æ€§æ¸¬è©¦å¤±æ•—ï¼æ’åºçµæœä¸ä¸€è‡´', 'error');
                        container.className = 'result error';
                    }
                } else {
                    log(`âŒ å•†å“æ•¸é‡ä¸ä¸€è‡´: ${orderJsProducts.length} vs ${adminServiceProducts.length}`, 'error');
                    container.className = 'result error';
                }

            } catch (error) {
                log(`âŒ æ•¸æ“šä¸€è‡´æ€§æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                container.className = 'result error';
            }
        }

        // è¼‰å…¥ä¸¦é¡¯ç¤ºå•†å“
        async function loadAndDisplayProducts() {
            const container = document.getElementById('productResult');
            const listContainer = document.getElementById('productList');
            container.innerHTML = '';
            container.style.display = 'block';
            listContainer.style.display = 'none';

            log('é–‹å§‹è¼‰å…¥å•†å“æ•¸æ“š...', 'info');

            try {
                const result = await AdminProductService.getProducts({
                    status: 'active',
                    sortBy: 'sortOrder',
                    sortOrder: 'asc',
                    limit: 10
                });

                log(`æˆåŠŸè¼‰å…¥ ${result.products.length} å€‹å•†å“`, 'success');

                // é¡¯ç¤ºå•†å“åˆ—è¡¨
                const productsHTML = result.products.map((product, index) => `
                    <div class="product-card">
                        <div class="product-name">${product.name}</div>
                        <div class="product-sort">${product.sortOrder || 999}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            ç¬¬ ${index + 1} ä½
                        </div>
                    </div>
                `).join('');

                listContainer.innerHTML = productsHTML;
                listContainer.style.display = 'grid';

            } catch (error) {
                log(`âŒ è¼‰å…¥å•†å“å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å‰µå»ºæ¸¬è©¦å•†å“
        async function createTestProducts() {
            const container = document.getElementById('productResult');
            container.innerHTML = '';
            container.style.display = 'block';

            log('å‰µå»ºæ¸¬è©¦å•†å“...', 'info');

            try {
                const testProducts = [
                    {
                        name: `æ¸¬è©¦å•†å“_${Date.now()}_1`,
                        price: 100,
                        category: 'æ¸¬è©¦åˆ†é¡',
                        description: 'æ¸¬è©¦å•†å“1',
                        status: 'active',
                        sortOrder: Math.floor(Math.random() * 50) + 1
                    },
                    {
                        name: `æ¸¬è©¦å•†å“_${Date.now()}_2`,
                        price: 150,
                        category: 'æ¸¬è©¦åˆ†é¡',
                        description: 'æ¸¬è©¦å•†å“2',
                        status: 'active',
                        sortOrder: Math.floor(Math.random() * 50) + 1
                    }
                ];

                for (const productData of testProducts) {
                    const result = await AdminProductService.createProduct(productData);
                    log(`âœ… å‰µå»ºå•†å“: ${result.name} (sortOrder: ${result.sortOrder})`, 'success');
                }

                log('æ¸¬è©¦å•†å“å‰µå»ºå®Œæˆ', 'success');

            } catch (error) {
                log(`âŒ å‰µå»ºæ¸¬è©¦å•†å“å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦åŒæ­¥
        async function testSync() {
            const container = document.getElementById('syncResult');
            container.innerHTML = '';
            container.style.display = 'block';

            log('é–‹å§‹åŒæ­¥æ¸¬è©¦...', 'info');

            try {
                // æ¨¡æ“¬ order.js è¼‰å…¥
                const db = firebase.firestore();
                const snapshot = await db.collection("products").get();
                
                const orderJsProducts = [];
                snapshot.forEach((doc) => {
                    const productData = doc.data();
                    if (productData.status === "active") {
                        orderJsProducts.push({
                            id: doc.id,
                            ...productData,
                        });
                    }
                });

                orderJsProducts.sort((a, b) => {
                    const aValue = a.sortOrder || 999;
                    const bValue = b.sortOrder || 999;
                    return aValue - bValue;
                });

                // ä½¿ç”¨ AdminProductService
                const result = await AdminProductService.getProducts({
                    status: 'active',
                    sortBy: 'sortOrder',
                    sortOrder: 'asc'
                });

                const adminServiceProducts = result.products;

                // é©—è­‰åŒæ­¥
                if (orderJsProducts.length === adminServiceProducts.length) {
                    let syncCount = 0;
                    for (let i = 0; i < orderJsProducts.length; i++) {
                        if (orderJsProducts[i].id === adminServiceProducts[i].id) {
                            syncCount++;
                        }
                    }

                    const syncRate = (syncCount / orderJsProducts.length) * 100;
                    log(`åŒæ­¥ç‡: ${syncRate.toFixed(1)}% (${syncCount}/${orderJsProducts.length})`, 'info');

                    if (syncRate === 100) {
                        log('âœ… å®Œå…¨åŒæ­¥ï¼å•†å“é é¢å’Œç®¡ç†é é¢æ’åºå®Œå…¨ä¸€è‡´', 'success');
                        container.className = 'result success';
                    } else {
                        log('âš ï¸ éƒ¨åˆ†åŒæ­¥ï¼Œå­˜åœ¨æ’åºå·®ç•°', 'error');
                        container.className = 'result error';
                    }
                } else {
                    log(`âŒ å•†å“æ•¸é‡ä¸ä¸€è‡´ï¼Œç„¡æ³•åŒæ­¥`, 'error');
                    container.className = 'result error';
                }

            } catch (error) {
                log(`âŒ åŒæ­¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                container.className = 'result error';
            }
        }

        // åŸ·è¡Œå®Œæ•´é©—è­‰
        async function runFullVerification() {
            log('ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´é©—è­‰...', 'info');

            // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
            testSortingLogic();
            setTimeout(() => testDataConsistency(), 1000);
            setTimeout(() => testSync(), 2000);
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('å¿«é€Ÿé©—è­‰æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
        });
    </script>
</body>
</html> 