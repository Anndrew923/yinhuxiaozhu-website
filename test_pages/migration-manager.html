<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數據遷移管理 | 隱湖小竹</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .migration-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .migration-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .migration-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .migration-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 15px;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }
        
        .migration-button:hover {
            background: #2980b9;
        }
        
        .migration-button.success {
            background: #27ae60;
        }
        
        .migration-button.success:hover {
            background: #229954;
        }
        
        .migration-button.warning {
            background: #f39c12;
        }
        
        .migration-button.warning:hover {
            background: #e67e22;
        }
        
        .migration-button.danger {
            background: #e74c3c;
        }
        
        .migration-button.danger:hover {
            background: #c0392b;
        }
        
        .migration-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .status-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #3498db;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-success {
            color: #2ecc71;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        .log-info {
            color: #3498db;
        }
        
        .log-warning {
            color: #f39c12;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-title {
            color: #856404;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .warning-text {
            color: #856404;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="migration-container">
        <div class="migration-section">
            <h1 class="migration-title">
                <i class="fas fa-database"></i>
                數據遷移管理
            </h1>
            <p>此頁面用於管理商品數據的遷移，確保前台訂餐頁面和管理員商品管理頁面使用相同的數據源。</p>
        </div>

        <div class="migration-section">
            <div class="warning-box">
                <div class="warning-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    重要提醒
                </div>
                <div class="warning-text">
                    <ul>
                        <li>請在執行遷移前備份您的數據</li>
                        <li>遷移過程不可逆，請謹慎操作</li>
                        <li>建議在非營業時間執行遷移</li>
                        <li>遷移完成後請測試前台和管理員頁面功能</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="migration-section">
            <h2 class="migration-title">數據狀態檢查</h2>
            <button class="migration-button" onclick="checkDataStatus()">
                <i class="fas fa-search"></i> 檢查數據狀態
            </button>
            <div id="statusContainer">
                <p>點擊「檢查數據狀態」查看當前數據情況</p>
            </div>
        </div>

        <div class="migration-section">
            <h2 class="migration-title">遷移操作</h2>
            <button class="migration-button" onclick="startMigration()">
                <i class="fas fa-arrow-right"></i> 開始遷移
            </button>
            <button class="migration-button warning" onclick="validateMigration()">
                <i class="fas fa-check-circle"></i> 驗證遷移
            </button>
            <button class="migration-button success" onclick="fixSortOrders()">
                <i class="fas fa-sort"></i> 修復排序值
            </button>
            <button class="migration-button danger" onclick="cleanupOldData()">
                <i class="fas fa-trash"></i> 清理舊數據
            </button>
            
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p id="progressText">準備中...</p>
            </div>
        </div>

        <div class="migration-section">
            <h2 class="migration-title">操作日誌</h2>
            <button class="migration-button" onclick="clearLog()">
                <i class="fas fa-trash"></i> 清除日誌
            </button>
            <div id="logContainer" class="log-container">
                <div class="log-entry log-info">等待操作開始...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/migration/stable-migration.js"></script>

    <script>
        let isProcessing = false;

        // 日誌功能
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">日誌已清除</div>';
        }

        // 更新進度條
        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
        }

        // 隱藏進度條
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        // 檢查數據狀態
        async function checkDataStatus() {
            try {
                log('開始檢查數據狀態...', 'info');
                updateProgress(10, '檢查數據狀態...');
                
                const result = await StableMigrationService.checkDataStatus();
                
                updateProgress(100, '檢查完成');
                
                const statusHtml = `
                    <div class="status-grid">
                        <div class="status-card">
                            <div class="status-title">menu_items 集合</div>
                            <div class="status-value">${result.menuItemsCount} 個項目</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">products 集合</div>
                            <div class="status-value">${result.productsCount} 個項目</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">重複ID</div>
                            <div class="status-value">${result.duplicateIds} 個</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">有排序值</div>
                            <div class="status-value">${result.productsWithSortOrder} 個</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">無排序值</div>
                            <div class="status-value">${result.productsWithoutSortOrder} 個</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">可遷移</div>
                            <div class="status-value">${result.canMigrate ? '是' : '否'}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('statusContainer').innerHTML = statusHtml;
                
                log(`數據狀態檢查完成: menu_items=${result.menuItemsCount}, products=${result.productsCount}`, 'success');
                
                setTimeout(hideProgress, 1000);
                
            } catch (error) {
                log(`檢查數據狀態失敗: ${error.message}`, 'error');
                hideProgress();
            }
        }

        // 開始遷移
        async function startMigration() {
            if (isProcessing) {
                log('已有操作正在進行中，請稍候', 'warning');
                return;
            }

            const confirmed = confirm('確定要開始遷移嗎？此操作將把 menu_items 集合的數據遷移到 products 集合。');
            if (!confirmed) {
                return;
            }

            isProcessing = true;
            
            try {
                log('開始數據遷移...', 'info');
                updateProgress(20, '開始遷移...');
                
                const result = await StableMigrationService.migrateMenuItemsToProducts();
                
                updateProgress(100, '遷移完成');
                
                log(`遷移完成: ${result.message}`, 'success');
                log(`詳細結果: 成功=${result.migrated}, 跳過=${result.skipped}, 錯誤=${result.errors}`, 'info');
                
                if (result.errors > 0) {
                    log(`有 ${result.errors} 個商品遷移失敗，請檢查日誌`, 'warning');
                }
                
                // 自動檢查狀態
                setTimeout(() => {
                    checkDataStatus();
                }, 1000);
                
            } catch (error) {
                log(`遷移失敗: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                setTimeout(hideProgress, 1000);
            }
        }

        // 驗證遷移
        async function validateMigration() {
            if (isProcessing) {
                log('已有操作正在進行中，請稍候', 'warning');
                return;
            }

            isProcessing = true;
            
            try {
                log('開始驗證遷移結果...', 'info');
                updateProgress(50, '驗證中...');
                
                const result = await StableMigrationService.checkDataStatus();
                
                updateProgress(100, '驗證完成');
                
                log(`驗證完成: menu_items=${result.menuItemsCount}, products=${result.productsCount}`, 'success');
                
                if (result.duplicateIds > 0) {
                    log(`發現 ${result.duplicateIds} 個重複ID`, 'warning');
                }
                
                if (result.productsWithoutSortOrder > 0) {
                    log(`發現 ${result.productsWithoutSortOrder} 個商品缺少排序值`, 'warning');
                }
                
            } catch (error) {
                log(`驗證失敗: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                setTimeout(hideProgress, 1000);
            }
        }

        // 修復排序值
        async function fixSortOrders() {
            if (isProcessing) {
                log('已有操作正在進行中，請稍候', 'warning');
                return;
            }

            const confirmed = confirm('確定要修復缺少排序值的商品嗎？');
            if (!confirmed) {
                return;
            }

            isProcessing = true;
            
            try {
                log('開始修復排序值...', 'info');
                updateProgress(30, '修復排序值...');
                
                const result = await StableMigrationService.fixSortOrders();
                
                updateProgress(100, '修復完成');
                
                log(`修復完成: ${result.message}`, 'success');
                log(`詳細結果: 修復了 ${result.fixed} 個商品`, 'info');
                
                if (result.fixed === 0) {
                    log('所有商品都有排序值，無需修復', 'info');
                }
                
            } catch (error) {
                log(`修復排序值失敗: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                setTimeout(hideProgress, 1000);
            }
        }

        // 清理舊數據
        async function cleanupOldData() {
            if (isProcessing) {
                log('已有操作正在進行中，請稍候', 'warning');
                return;
            }

            const confirmed = confirm('確定要清理 menu_items 集合嗎？此操作不可逆！');
            if (!confirmed) {
                return;
            }

            const confirmedAgain = confirm('再次確認：此操作將永久刪除 menu_items 集合中的所有數據！');
            if (!confirmedAgain) {
                return;
            }

            isProcessing = true;
            
            try {
                log('開始清理舊數據...', 'warning');
                updateProgress(40, '清理中...');
                
                const result = await StableMigrationService.cleanupMenuItems();
                
                updateProgress(100, '清理完成');
                
                log(`清理完成: ${result.message}`, 'success');
                log(`詳細結果: 刪除了 ${result.deleted} 個 menu_items`, 'info');
                
                // 自動檢查狀態
                setTimeout(() => {
                    checkDataStatus();
                }, 1000);
                
            } catch (error) {
                log(`清理失敗: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                setTimeout(hideProgress, 1000);
            }
        }

        // 頁面載入完成後自動檢查狀態
        window.addEventListener('load', () => {
            log('遷移管理頁面已載入', 'info');
            setTimeout(() => {
                checkDataStatus();
            }, 1000);
        });
    </script>
</body>
</html> 