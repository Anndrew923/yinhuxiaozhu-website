<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®‰å…¨è¨­å®š - éš±æ¹–å°ç«¹</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .security-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .security-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .security-section h2 {
        color: #2c5530;
        border-bottom: 2px solid #4a7c59;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      .security-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }

      .security-item:last-child {
        border-bottom: none;
      }

      .security-info {
        flex: 1;
      }

      .security-info h3 {
        margin: 0 0 5px 0;
        color: #4a7c59;
      }

      .security-info p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .security-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #4a7c59;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #4a7c59;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn:hover {
        opacity: 0.8;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-active {
        background: #28a745;
      }

      .status-inactive {
        background: #dc3545;
      }

      .status-warning {
        background: #ffc107;
      }

      .security-score {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #4a7c59, #2c5530);
        color: white;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .security-score h1 {
        margin: 0;
        font-size: 48px;
      }

      .security-score p {
        margin: 10px 0 0 0;
        opacity: 0.9;
      }

      .backup-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-top: 10px;
      }

      .backup-info p {
        margin: 5px 0;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="security-container">
      <h1>ğŸ”’ å®‰å…¨è¨­å®š</h1>

      <!-- å®‰å…¨è©•åˆ† -->
      <div class="security-score">
        <h1 id="security-score">--</h1>
        <p>ç¶²ç«™å®‰å…¨è©•åˆ†</p>
      </div>

      <!-- å¸³æˆ¶å®‰å…¨ -->
      <div class="security-section">
        <h2>å¸³æˆ¶å®‰å…¨</h2>

        <div class="security-item">
          <div class="security-info">
            <h3>å¯†ç¢¼å¼·åº¦</h3>
            <p>ç¢ºä¿æ‚¨çš„å¯†ç¢¼è¶³å¤ å¼·å£¯</p>
          </div>
          <div class="security-control">
            <span id="password-strength" class="status-indicator"></span>
            <button class="btn btn-primary" onclick="changePassword()">
              æ›´æ”¹å¯†ç¢¼
            </button>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>å…©æ­¥é©Ÿé©—è­‰</h3>
            <p>å¢åŠ é¡å¤–çš„å®‰å…¨ä¿è­·å±¤</p>
          </div>
          <div class="security-control">
            <label class="switch">
              <input type="checkbox" id="two-factor-auth" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>ç™»å…¥å˜—è©¦é™åˆ¶</h3>
            <p>é˜²æ­¢æš´åŠ›ç ´è§£æ”»æ“Š</p>
          </div>
          <div class="security-control">
            <span id="login-attempts-status" class="status-indicator"></span>
            <span id="login-attempts-info">æª¢æŸ¥ä¸­...</span>
          </div>
        </div>
      </div>

      <!-- è³‡æ–™ä¿è­· -->
      <div class="security-section">
        <h2>è³‡æ–™ä¿è­·</h2>

        <div class="security-item">
          <div class="security-info">
            <h3>è³‡æ–™åŠ å¯†</h3>
            <p>ç¢ºä¿æ•æ„Ÿè³‡æ–™çš„å®‰å…¨å„²å­˜</p>
          </div>
          <div class="security-control">
            <span id="encryption-status" class="status-indicator"></span>
            <span id="encryption-info">æª¢æŸ¥ä¸­...</span>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>è‡ªå‹•å‚™ä»½</h3>
            <p>å®šæœŸå‚™ä»½æ‚¨çš„è³‡æ–™</p>
          </div>
          <div class="security-control">
            <label class="switch">
              <input type="checkbox" id="auto-backup" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>æ‰‹å‹•å‚™ä»½</h3>
            <p>ç«‹å³å»ºç«‹è³‡æ–™å‚™ä»½</p>
          </div>
          <div class="security-control">
            <button class="btn btn-primary" onclick="createBackup()">
              å»ºç«‹å‚™ä»½
            </button>
            <button class="btn btn-secondary" onclick="restoreBackup()">
              æ¢å¾©å‚™ä»½
            </button>
          </div>
        </div>

        <div id="backup-info" class="backup-info" style="display: none">
          <p id="backup-status">å‚™ä»½ç‹€æ…‹</p>
          <p id="backup-time">æœ€å¾Œå‚™ä»½æ™‚é–“</p>
        </div>
      </div>

      <!-- æœƒè©±ç®¡ç† -->
      <div class="security-section">
        <h2>æœƒè©±ç®¡ç†</h2>

        <div class="security-item">
          <div class="security-info">
            <h3>æœƒè©±ç‹€æ…‹</h3>
            <p>æª¢æŸ¥ç•¶å‰æœƒè©±æ˜¯å¦æœ‰æ•ˆ</p>
          </div>
          <div class="security-control">
            <span id="session-status" class="status-indicator"></span>
            <span id="session-info">æª¢æŸ¥ä¸­...</span>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>è‡ªå‹•ç™»å‡º</h3>
            <p>é–’ç½®æ™‚è‡ªå‹•ç™»å‡º</p>
          </div>
          <div class="security-control">
            <label class="switch">
              <input type="checkbox" id="auto-logout" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>ç™»å‡ºæ‰€æœ‰è£ç½®</h3>
            <p>å¼·åˆ¶ç™»å‡ºæ‰€æœ‰å·²ç™»å…¥çš„è£ç½®</p>
          </div>
          <div class="security-control">
            <button class="btn btn-danger" onclick="logoutAllDevices()">
              ç™»å‡ºæ‰€æœ‰è£ç½®
            </button>
          </div>
        </div>
      </div>

      <!-- éš±ç§è¨­å®š -->
      <div class="security-section">
        <h2>éš±ç§è¨­å®š</h2>

        <div class="security-item">
          <div class="security-info">
            <h3>Cookie è¨­å®š</h3>
            <p>ç®¡ç† Cookie ä½¿ç”¨åå¥½</p>
          </div>
          <div class="security-control">
            <button class="btn btn-primary" onclick="openCookieSettings()">
              ç®¡ç† Cookie
            </button>
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>è³‡æ–™æ”¶é›†</h3>
            <p>æ§åˆ¶è³‡æ–™æ”¶é›†å’Œä½¿ç”¨</p>
          </div>
          <div class="security-control">
            <a
              href="privacy-policy.html"
              class="btn btn-secondary"
              target="_blank"
              >éš±ç§æ¬Šæ”¿ç­–</a
            >
          </div>
        </div>

        <div class="security-item">
          <div class="security-info">
            <h3>åˆªé™¤å¸³æˆ¶</h3>
            <p>æ°¸ä¹…åˆªé™¤æ‚¨çš„å¸³æˆ¶å’Œæ‰€æœ‰è³‡æ–™</p>
          </div>
          <div class="security-control">
            <button class="btn btn-danger" onclick="deleteAccount()">
              åˆªé™¤å¸³æˆ¶
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„ JavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/services/security.service.js"></script>
    <script src="js/cookie-consent.js"></script>

    <script>
      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initializeSecuritySettings();
      });

      function initializeSecuritySettings() {
        // æª¢æŸ¥å®‰å…¨è©•åˆ†
        updateSecurityScore();

        // æª¢æŸ¥å„é …å®‰å…¨ç‹€æ…‹
        updatePasswordStrength();
        updateLoginAttempts();
        updateEncryptionStatus();
        updateSessionStatus();
        updateBackupInfo();

        // è¼‰å…¥è¨­å®š
        loadSettings();

        // ç¶å®šäº‹ä»¶
        bindEvents();
      }

      function updateSecurityScore() {
        if (window.SecurityService) {
          const securityCheck = SecurityService.performSecurityCheck();
          document.getElementById("security-score").textContent =
            securityCheck.percentage;

          // æ ¹æ“šè©•åˆ†è¨­å®šé¡è‰²
          const scoreElement = document.getElementById("security-score");
          if (securityCheck.percentage >= 80) {
            scoreElement.style.color = "#28a745";
          } else if (securityCheck.percentage >= 60) {
            scoreElement.style.color = "#ffc107";
          } else {
            scoreElement.style.color = "#dc3545";
          }
        }
      }

      function updatePasswordStrength() {
        // é€™è£¡æ‡‰è©²å¾å¯¦éš›çš„å¯†ç¢¼æª¢æŸ¥çµæœå–å¾—
        const strengthIndicator = document.getElementById("password-strength");
        strengthIndicator.className = "status-indicator status-active";
      }

      function updateLoginAttempts() {
        if (window.SecurityService) {
          const attempts = SecurityService.checkLoginAttempts();
          const statusElement = document.getElementById(
            "login-attempts-status"
          );
          const infoElement = document.getElementById("login-attempts-info");

          if (attempts.isLocked) {
            statusElement.className = "status-indicator status-warning";
            infoElement.textContent = `å·²é–å®š (${Math.ceil(
              attempts.remainingTime / 60000
            )}åˆ†é˜å¾Œè§£é–)`;
          } else {
            statusElement.className = "status-indicator status-active";
            infoElement.textContent = `æ­£å¸¸ (${attempts.count}/5æ¬¡å˜—è©¦)`;
          }
        }
      }

      function updateEncryptionStatus() {
        const statusElement = document.getElementById("encryption-status");
        const infoElement = document.getElementById("encryption-info");

        // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ HTTPS
        if (window.location.protocol === "https:") {
          statusElement.className = "status-indicator status-active";
          infoElement.textContent = "å·²å•Ÿç”¨ (HTTPS)";
        } else {
          statusElement.className = "status-indicator status-warning";
          infoElement.textContent = "å»ºè­°ä½¿ç”¨ HTTPS";
        }
      }

      function updateSessionStatus() {
        if (window.SecurityService) {
          const isValid = SecurityService.isSessionValid();
          const statusElement = document.getElementById("session-status");
          const infoElement = document.getElementById("session-info");

          if (isValid) {
            statusElement.className = "status-indicator status-active";
            infoElement.textContent = "æœ‰æ•ˆ";
          } else {
            statusElement.className = "status-indicator status-inactive";
            infoElement.textContent = "å·²éæœŸ";
          }
        }
      }

      function updateBackupInfo() {
        if (window.SecurityService) {
          const backupInfo = SecurityService.checkDataBackup();
          const backupInfoDiv = document.getElementById("backup-info");
          const statusElement = document.getElementById("backup-status");
          const timeElement = document.getElementById("backup-time");

          if (backupInfo.lastBackup) {
            backupInfoDiv.style.display = "block";
            statusElement.textContent = `å‚™ä»½ç‹€æ…‹: ${
              backupInfo.backupEnabled ? "å·²å•Ÿç”¨" : "æœªå•Ÿç”¨"
            }`;
            timeElement.textContent = `æœ€å¾Œå‚™ä»½: ${new Date(
              parseInt(backupInfo.lastBackup)
            ).toLocaleString()}`;
          }
        }
      }

      function loadSettings() {
        // è¼‰å…¥è‡ªå‹•å‚™ä»½è¨­å®š
        const autoBackup = localStorage.getItem("yinhu_auto_backup") === "true";
        document.getElementById("auto-backup").checked = autoBackup;

        // è¼‰å…¥è‡ªå‹•ç™»å‡ºè¨­å®š
        const autoLogout =
          localStorage.getItem("yinhu_auto_logout") !== "false";
        document.getElementById("auto-logout").checked = autoLogout;

        // è¼‰å…¥å…©æ­¥é©Ÿé©—è­‰è¨­å®š
        const twoFactor = localStorage.getItem("yinhu_two_factor") === "true";
        document.getElementById("two-factor-auth").checked = twoFactor;
      }

      function bindEvents() {
        // è‡ªå‹•å‚™ä»½è¨­å®š
        document
          .getElementById("auto-backup")
          .addEventListener("change", function (e) {
            localStorage.setItem("yinhu_auto_backup", e.target.checked);
            if (e.target.checked) {
              SecurityService.createDataBackup();
            }
          });

        // è‡ªå‹•ç™»å‡ºè¨­å®š
        document
          .getElementById("auto-logout")
          .addEventListener("change", function (e) {
            localStorage.setItem("yinhu_auto_logout", e.target.checked);
          });

        // å…©æ­¥é©Ÿé©—è­‰è¨­å®š
        document
          .getElementById("two-factor-auth")
          .addEventListener("change", function (e) {
            localStorage.setItem("yinhu_two_factor", e.target.checked);
            if (e.target.checked) {
              alert("å…©æ­¥é©Ÿé©—è­‰åŠŸèƒ½éœ€è¦é¡å¤–è¨­å®šï¼Œè«‹è¯ç¹«å®¢æœã€‚");
            }
          });
      }

      function changePassword() {
        const newPassword = prompt("è«‹è¼¸å…¥æ–°å¯†ç¢¼:");
        if (newPassword) {
          if (window.SecurityService) {
            const validation = SecurityService.validatePassword(newPassword);
            if (validation.isValid) {
              alert("å¯†ç¢¼å¼·åº¦è‰¯å¥½ï¼è«‹åœ¨ç™»å…¥é é¢æ›´æ–°æ‚¨çš„å¯†ç¢¼ã€‚");
            } else {
              alert("å¯†ç¢¼ä¸ç¬¦åˆè¦æ±‚:\n" + validation.errors.join("\n"));
            }
          }
        }
      }

      function createBackup() {
        if (window.SecurityService) {
          const result = SecurityService.createDataBackup();
          if (result.success) {
            alert("è³‡æ–™å‚™ä»½å»ºç«‹æˆåŠŸï¼");
            updateBackupInfo();
          } else {
            alert("è³‡æ–™å‚™ä»½å¤±æ•—: " + result.error);
          }
        }
      }

      function restoreBackup() {
        if (confirm("ç¢ºå®šè¦æ¢å¾©å‚™ä»½è³‡æ–™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹ç•¶å‰çš„è³‡æ–™ã€‚")) {
          if (window.SecurityService) {
            const result = SecurityService.restoreDataBackup();
            if (result.success) {
              alert("è³‡æ–™æ¢å¾©æˆåŠŸï¼");
              location.reload();
            } else {
              alert("è³‡æ–™æ¢å¾©å¤±æ•—: " + result.error);
            }
          }
        }
      }

      function logoutAllDevices() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºæ‰€æœ‰è£ç½®å—ï¼Ÿ")) {
          // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å„²å­˜çš„è³‡æ–™
          localStorage.clear();
          sessionStorage.clear();
          alert("å·²ç™»å‡ºæ‰€æœ‰è£ç½®ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
          window.location.href = "login.html";
        }
      }

      function openCookieSettings() {
        if (window.CookieConsent) {
          CookieConsent.showCookieSettings();
        } else {
          alert("Cookie è¨­å®šåŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚");
        }
      }

      function deleteAccount() {
        if (
          confirm(
            "è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‚¨çš„å¸³æˆ¶å’Œæ‰€æœ‰è³‡æ–™ï¼Œç„¡æ³•å¾©åŸã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ"
          )
        ) {
          if (confirm("æœ€å¾Œç¢ºèªï¼šæ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å¸³æˆ¶å—ï¼Ÿ")) {
            alert(
              "å¸³æˆ¶åˆªé™¤åŠŸèƒ½éœ€è¦è¯ç¹«å®¢æœè™•ç†ã€‚è«‹ç™¼é€éƒµä»¶è‡³ support@yinhu.com"
            );
          }
        }
      }
    </script>
  </body>
</html>
