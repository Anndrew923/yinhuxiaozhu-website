<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菜單管理 (簡化版) | 隱湖小竹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .products-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .product-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .product-info {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .console-output {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>菜單管理 (簡化測試版)</h1>
            <div id="authStatus" class="status warning">檢查中...</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="noodlesCount">-</div>
                <div>麵食商品</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="drinksCount">-</div>
                <div>飲品商品</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">-</div>
                <div>總計商品</div>
            </div>
        </div>

        <div class="products-section">
            <div class="toolbar">
                <h2>商品列表</h2>
                <div>
                    <select id="categoryFilter">
                        <option value="">所有分類</option>
                    </select>
                    <button class="btn btn-success" onclick="createTestProduct()">新增測試商品</button>
                    <button class="btn btn-primary" onclick="loadProducts()">重新載入</button>
                    <button class="btn btn-secondary" onclick="clearConsole()">清除日誌</button>
                </div>
            </div>
            
            <div id="productsContainer" class="loading">載入中...</div>
            
            <div class="console-output" id="consoleOutput"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/services/auth.service.js"></script>
    <script src="js/services/product.service.js"></script>

    <script>
        // 重寫 console.log 來捕獲輸出
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function updateAuthStatus(message, type = 'success') {
            const authStatus = document.getElementById('authStatus');
            authStatus.textContent = message;
            authStatus.className = `status ${type}`;
        }

        let products = [];

        // 簡化的權限檢查
        async function checkAuth() {
            try {
                console.log("開始簡化權限檢查...");
                updateAuthStatus('檢查中...', 'warning');
                
                // 等待 Firebase 初始化
                await new Promise(resolve => {
                    const checkFirebase = () => {
                        if (window.firebaseAuth && window.firebaseDB) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });

                console.log("Firebase 已初始化，跳過權限檢查（本地測試）");
                updateAuthStatus('本地測試模式 - 已跳過權限檢查', 'success');
                
            } catch (error) {
                console.error("權限檢查失敗:", error);
                updateAuthStatus(`權限檢查失敗: ${error.message}`, 'error');
            }
        }

        // 載入統計資料
        async function loadStats() {
            try {
                console.log("開始載入統計資料...");
                const allProducts = await ProductService.getAllProducts();
                console.log(`獲取到所有商品: ${allProducts.length} 個`);
                
                const noodlesCount = allProducts.filter(p => p.category === '麵食').length;
                const drinksCount = allProducts.filter(p => p.category === '飲品').length;
                const totalCount = allProducts.length;

                document.getElementById("noodlesCount").textContent = noodlesCount;
                document.getElementById("drinksCount").textContent = drinksCount;
                document.getElementById("totalCount").textContent = totalCount;
                
                console.log(`統計結果: 麵食 ${noodlesCount}, 飲品 ${drinksCount}, 總計 ${totalCount}`);
            } catch (error) {
                console.error("載入統計資料失敗:", error);
            }
        }

        // 載入分類
        async function loadCategories() {
            try {
                console.log("開始載入分類...");
                const categories = await ProductService.getCategories();
                console.log("獲取到分類:", categories);
                
                const categoryFilter = document.getElementById("categoryFilter");
                categoryFilter.innerHTML = '<option value="">所有分類</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                
                console.log(`分類載入完成，共 ${categories.length} 個分類`);
            } catch (error) {
                console.error("載入分類失敗:", error);
            }
        }

        // 載入商品列表
        async function loadProducts() {
            try {
                console.log("開始載入商品列表...");
                const container = document.getElementById("productsContainer");
                container.innerHTML = '<div class="loading">載入中...</div>';

                const category = document.getElementById("categoryFilter").value;
                const options = {
                    orderBy: 'sortOrder',
                    orderDirection: 'asc'
                };
                
                if (category) {
                    options.category = category;
                }
                
                console.log("載入商品選項:", options);
                products = await ProductService.getAllProducts(options);
                console.log(`載入商品成功: ${products.length} 個商品`);

                if (products.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>尚無商品</h3>
                            <p>點擊「新增測試商品」開始建立您的菜單</p>
                        </div>
                    `;
                    return;
                }

                const productsHtml = products.map(product => `
                    <div class="product-card">
                        <div class="product-name">${product.name}</div>
                        <div class="product-info">分類: ${product.category}</div>
                        <div class="product-info">價格: NT$ ${product.price}</div>
                        <div class="product-info">狀態: ${product.isAvailable ? '上架' : '下架'}</div>
                        <div class="product-info">排序: ${product.sortOrder || 0}</div>
                        <div class="product-info">描述: ${product.description || '無描述'}</div>
                    </div>
                `).join('');

                container.innerHTML = `<div class="products-grid">${productsHtml}</div>`;
                console.log("商品列表渲染完成");
            } catch (error) {
                console.error("載入商品失敗:", error);
                document.getElementById("productsContainer").innerHTML = `
                    <div style="text-align: center; padding: 40px; color: red;">
                        <h3>載入失敗</h3>
                        <p>錯誤: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadProducts()">重試</button>
                    </div>
                `;
            }
        }

        // 創建測試商品
        async function createTestProduct() {
            try {
                console.log("開始創建測試商品...");
                
                const testProduct = {
                    name: `測試商品_${Date.now()}`,
                    category: '測試',
                    price: Math.floor(Math.random() * 200) + 50,
                    description: '這是一個測試商品',
                    isAvailable: true,
                    sortOrder: Math.floor(Math.random() * 100)
                };
                
                const result = await ProductService.createProduct(testProduct);
                console.log(`測試商品創建成功: ${result.name} (ID: ${result.id})`);
                
                // 重新載入數據
                await loadStats();
                await loadCategories();
                await loadProducts();
                
            } catch (error) {
                console.error("創建測試商品失敗:", error);
                alert(`創建測試商品失敗: ${error.message}`);
            }
        }

        // 分類篩選事件
        document.getElementById("categoryFilter").addEventListener("change", loadProducts);

        // 頁面初始化
        document.addEventListener("DOMContentLoaded", async function() {
            console.log("簡化版菜單管理頁面載入完成");
            
            try {
                await checkAuth();
                await loadCategories();
                await loadStats();
                await loadProducts();
                
                console.log("所有初始化完成");
            } catch (error) {
                console.error("初始化失敗:", error);
            }
        });
    </script>
</body>
</html>