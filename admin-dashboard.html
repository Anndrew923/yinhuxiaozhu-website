<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ç®¡ç†å¾Œå° | éš±æ¹–å°ç«¹</title>
  <!-- Cache Bust Version: 2025.01.08.003 - FORCE REFRESH -->
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans TC", sans-serif;
        background: #f5f6fa;
        color: #333;
      }

      /* å´é‚Šæ¬„ */
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 260px;
        height: 100vh;
        background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
        color: white;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .sidebar.mobile-hidden {
        transform: translateX(-100%);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-header .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .sidebar-header .logo img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
      }

      .sidebar-header .logo i {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .sidebar-header h1 {
        font-size: 18px;
        font-weight: 600;
      }

      .admin-info {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 5px;
      }

      .sidebar-nav {
        padding: 10px 0;
      }

      .nav-section {
        margin-bottom: 20px;
      }

      .nav-section-title {
        padding: 10px 20px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .nav-item {
        display: block;
        padding: 12px 20px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-left-color: #3498db;
      }

      .nav-item.active {
        background: rgba(52, 152, 219, 0.2);
        color: white;
        border-left-color: #3498db;
      }

      .nav-item i {
        width: 20px;
        margin-right: 10px;
        font-size: 14px;
      }

      /* ä¸»è¦å…§å®¹å€ */
      .main-content {
        margin-left: 260px;
        min-height: 100vh;
        transition: margin-left 0.3s ease;
      }

      .main-content.expanded {
        margin-left: 0;
      }

      /* é ‚éƒ¨å°èˆª */
      .top-nav {
        background: white;
        padding: 15px 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 20px;
        color: #333;
        cursor: pointer;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #2c3e50;
      }

      .top-nav-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .notification-btn {
        position: relative;
        background: none;
        border: none;
        font-size: 18px;
        color: #666;
        cursor: pointer;
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #e74c3c;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

             .admin-profile {
         display: flex;
         align-items: center;
         gap: 10px;
         cursor: pointer;
         position: relative;
         padding: 8px 12px;
         border-radius: 8px;
         transition: background-color 0.2s ease;
       }

       .admin-profile:hover {
         background-color: #f8f9fa;
       }

       .admin-profile #adminName {
         cursor: pointer;
         transition: color 0.2s ease;
       }

       .admin-profile #adminName:hover {
         color: #3498db;
         text-decoration: underline;
       }

               .admin-profile .logout-btn {
          background: none;
          border: none;
          color: #e74c3c;
          cursor: pointer;
          padding: 0;
          font-size: inherit;
          transition: color 0.2s ease;
        }

        .admin-profile .logout-btn:hover {
          color: #c0392b;
        }

      .admin-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      /* ä¸»è¦å…§å®¹ */
      .content-area {
        padding: 30px;
      }

      /* çµ±è¨ˆå¡ç‰‡ */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .stat-title {
        font-size: 14px;
        color: #666;
        font-weight: 500;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
      }

      .stat-icon.orders {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .stat-icon.revenue {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }
      .stat-icon.products {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
      }
      .stat-icon.customers {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .stat-change {
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .stat-change.positive {
        color: #27ae60;
      }

      .stat-change.negative {
        color: #e74c3c;
      }

      /* å¿«é€Ÿå‹•ä½œ */
      .quick-actions {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .quick-actions h3 {
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: 600;
      }

      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .action-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px 20px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        text-decoration: none;
        color: #495057;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        background: #e9ecef;
        border-color: #dee2e6;
        transform: translateY(-2px);
      }

      .action-btn i {
        font-size: 18px;
      }

      /* æœ€è¿‘æ´»å‹• */
      .recent-activities {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      .recent-activities h3 {
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: 600;
      }

      .activity-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid #f1f2f6;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: white;
      }

      .activity-icon.new-order {
        background: #3498db;
      }
      .activity-icon.payment {
        background: #27ae60;
      }
      .activity-icon.shipped {
        background: #f39c12;
      }
      .activity-icon.delivered {
        background: #9b59b6;
      }

      .activity-content {
        flex: 1;
      }

      .activity-text {
        font-size: 14px;
        color: #2c3e50;
        margin-bottom: 2px;
      }

      .activity-time {
        font-size: 12px;
        color: #7f8c8d;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 1024px) {
        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .action-buttons {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.mobile-shown {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .mobile-menu-btn {
          display: block;
        }

        .top-nav {
          padding: 15px 20px;
        }

        .content-area {
          padding: 20px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }

      /* å´é‚Šæ¬„è¦†è“‹å±¤ */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      @media (max-width: 768px) {
        .sidebar-overlay.show {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <!-- å´é‚Šæ¬„è¦†è“‹å±¤ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- å´é‚Šæ¬„ -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-leaf"></i>
          <div>
            <h1>éš±æ¹–å°ç«¹</h1>
            <div class="admin-info" id="adminInfo">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
          <a href="#" class="nav-item active" data-page="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            æ§åˆ¶å°
          </a>
          <a href="#" class="nav-item" data-page="orders">
            <i class="fas fa-shopping-bag"></i>
            è¨‚å–®ç®¡ç†
          </a>
          <a href="#" class="nav-item" data-page="products">
            <i class="fas fa-box"></i>
            å•†å“ç®¡ç†
          </a>
                          <a href="admin-menu.html" class="nav-item">
            <i class="fas fa-utensils"></i>
            èœå–®ç®¡ç†
          </a>
          <a href="#" class="nav-item" data-page="customers">
            <i class="fas fa-users"></i>
            å®¢æˆ¶ç®¡ç†
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">è²¡å‹™èˆ‡å ±è¡¨</div>
          <a href="#" class="nav-item" data-page="reports">
            <i class="fas fa-chart-bar"></i>
            ç‡Ÿæ¥­å ±è¡¨
          </a>
          <a href="#" class="nav-item" data-page="finance">
            <i class="fas fa-dollar-sign"></i>
            è²¡å‹™ç®¡ç†
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">ç³»çµ±è¨­å®š</div>
          <a href="#" class="nav-item" data-page="settings">
            <i class="fas fa-cog"></i>
            ç³»çµ±è¨­å®š
          </a>
          <a href="#" class="nav-item" data-page="admins">
            <i class="fas fa-user-shield"></i>
            ç®¡ç†å“¡ç®¡ç†
          </a>
        </div>
      </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content" id="mainContent">
      <!-- é ‚éƒ¨å°èˆª -->
      <header class="top-nav">
        <div style="display: flex; align-items: center; gap: 15px">
          <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="page-title" id="pageTitle">æ§åˆ¶å°</h1>
        </div>

        <div class="top-nav-actions">
                  <button class="notification-btn" onclick="showDevelopmentNotice()" title="åŠŸèƒ½é–‹ç™¼ä¸­">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationBadge">é–‹ç™¼ä¸­</span>
        </button>

                     <div class="admin-profile">
             <div class="admin-avatar" id="adminAvatar">A</div>
             <span id="adminName">ç®¡ç†å“¡</span>
             <button class="logout-btn" id="logoutBtn" title="ç™»å‡º">
               <i class="fas fa-sign-out-alt"></i>
             </button>
           </div>
        </div>
      </header>

      <!-- å…§å®¹å€åŸŸ -->
      <div class="content-area">
        <!-- æ§åˆ¶å°å…§å®¹ -->
        <div id="dashboardContent">
          <!-- çµ±è¨ˆå¡ç‰‡ -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-title">ä»Šæ—¥è¨‚å–®</span>
                <div class="stat-icon orders">
                  <i class="fas fa-shopping-bag"></i>
                </div>
              </div>
              <div class="stat-value" id="todayOrders">-</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+12% è¼ƒæ˜¨æ—¥</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-title">ä»Šæ—¥ç‡Ÿæ¥­é¡</span>
                <div class="stat-icon revenue">
                  <i class="fas fa-dollar-sign"></i>
                </div>
              </div>
              <div class="stat-value" id="todayRevenue">-</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+8% è¼ƒæ˜¨æ—¥</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-title">å•†å“ç¸½æ•¸</span>
                <div class="stat-icon products">
                  <i class="fas fa-box"></i>
                </div>
              </div>
              <div class="stat-value" id="totalProducts">-</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+3 å€‹æ–°å•†å“</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-title">æœƒå“¡ç¸½æ•¸</span>
                <div class="stat-icon customers">
                  <i class="fas fa-users"></i>
                </div>
              </div>
              <div class="stat-value" id="totalCustomers">-</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+5 ä½æ–°æœƒå“¡</span>
              </div>
            </div>
          </div>

          <!-- å¿«é€Ÿå‹•ä½œ -->
          <div class="quick-actions">
            <h3>å¿«é€Ÿå‹•ä½œ</h3>
            <div class="action-buttons">
              <a href="#" class="action-btn" data-page="orders">
                <i class="fas fa-plus"></i>
                <span>è™•ç†æ–°è¨‚å–®</span>
              </a>
              <a href="#" class="action-btn" data-page="products">
                <i class="fas fa-box"></i>
                <span>æ–°å¢å•†å“</span>
              </a>
              <a href="#" class="action-btn" data-page="reports">
                <i class="fas fa-chart-line"></i>
                <span>æŸ¥çœ‹å ±è¡¨</span>
              </a>
              <a href="#" class="action-btn" data-page="customers">
                <i class="fas fa-user-plus"></i>
                <span>å®¢æˆ¶ç®¡ç†</span>
              </a>
            </div>
          </div>

          <!-- æœ€è¿‘æ´»å‹• -->
          <div class="recent-activities">
            <h3>æœ€è¿‘æ´»å‹• <span style="font-size: 12px; color: #e74c3c; font-weight: normal;">(é–‹ç™¼ä¸­)</span></h3>
            <div id="recentActivitiesContainer">
              <div class="activity-item" style="opacity: 0.6;">
                <div class="activity-icon new-order">
                  <i class="fas fa-tools"></i>
                </div>
                <div class="activity-content">
                  <div class="activity-text">åŠŸèƒ½é–‹ç™¼ä¸­ - å³å°‡æ¨å‡º</div>
                  <div class="activity-time">æ•¬è«‹æœŸå¾…</div>
                </div>
              </div>

              <div class="activity-item" style="opacity: 0.6;">
                <div class="activity-icon payment">
                  <i class="fas fa-code"></i>
                </div>
                <div class="activity-content">
                  <div class="activity-text">ç³»çµ±æ•´åˆä¸­</div>
                  <div class="activity-time">é–‹ç™¼éšæ®µ</div>
                </div>
              </div>

              <div class="activity-item" style="opacity: 0.6;">
                <div class="activity-icon shipped">
                  <i class="fas fa-rocket"></i>
                </div>
                <div class="activity-content">
                  <div class="activity-text">å³å°‡ä¸Šç·š</div>
                  <div class="activity-time">æ¸¬è©¦éšæ®µ</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å…¶ä»–é é¢å…§å®¹å°‡é€šé JavaScript å‹•æ…‹è¼‰å…¥ -->
        <div id="dynamicContent" style="display: none"></div>
      </div>
    </main>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/services/auth.service.js"></script>
    <script src="js/services/order.service.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let currentAdmin = null;

        // DOM å…ƒç´ 
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const mainContent = document.getElementById("mainContent");
        const pageTitle = document.getElementById("pageTitle");
        const adminInfo = document.getElementById("adminInfo");
        const adminName = document.getElementById("adminName");
        const adminAvatar = document.getElementById("adminAvatar");
        const dashboardContent = document.getElementById("dashboardContent");
        const dynamicContent = document.getElementById("dynamicContent");

        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        firebase.auth().onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = "admin-login.html";
            return;
          }

          // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
          const adminCheck = await AuthService.checkAdminRole(user.uid);
          if (!adminCheck.isAdmin) {
            alert("æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™");
            await AuthService.signOut();
            window.location.href = "admin-login.html";
            return;
          }

                     currentAdmin = adminCheck.adminData;
           
           // æ·»åŠ  uid åˆ°ç®¡ç†å“¡è³‡æ–™ä¸­
           currentAdmin.uid = user.uid;
           
           // é©—è­‰ç®¡ç†å“¡è³‡æ–™å®Œæ•´æ€§
           if (!currentAdmin || !currentAdmin.name || !currentAdmin.email) {
             console.error('ç®¡ç†å“¡è³‡æ–™ä¸å®Œæ•´:', currentAdmin);
             alert('ç®¡ç†å“¡è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
             await AuthService.signOut();
             window.location.href = "admin-login.html";
             return;
           }
           
           updateAdminInfo(currentAdmin);
           loadDashboardData();
        });

                 // æ›´æ–°ç®¡ç†å“¡è³‡è¨Š
         function updateAdminInfo(adminData) {
           adminInfo.textContent = `${getRoleName(adminData.role)} | ${
             adminData.email
           }`;
           adminName.textContent = adminData.name;
           adminAvatar.textContent = adminData.name.charAt(0).toUpperCase();
           
           // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼Œé¿å…é‡è¤‡ç¶å®š
           adminName.removeEventListener('click', adminName._editHandler);
           
           // å‰µå»ºæ–°çš„äº‹ä»¶è™•ç†å™¨ä¸¦ä¿å­˜å¼•ç”¨
           adminName._editHandler = () => editAdminName(adminData);
           adminName.addEventListener('click', adminName._editHandler);
         }

        // ç²å–è§’è‰²åç¨±
        function getRoleName(role) {
          const roleNames = {
            super_admin: "è¶…ç´šç®¡ç†å“¡",
            order_manager: "è¨‚å–®ç®¡ç†å“¡",
            product_manager: "å•†å“ç®¡ç†å“¡",
            finance_manager: "è²¡å‹™ç®¡ç†å“¡",
            customer_service: "å®¢æœäººå“¡",
          };
          return roleNames[role] || role;
        }

        // è¼‰å…¥æ§åˆ¶å°æ•¸æ“š
        async function loadDashboardData() {
          try {
            // è¼‰å…¥ä»Šæ—¥è¨‚å–®æ•¸
            const todayOrdersCount = await getTodayOrdersCount();
            document.getElementById("todayOrders").textContent =
              todayOrdersCount;

            // è¼‰å…¥ä»Šæ—¥ç‡Ÿæ¥­é¡
            const todayRevenue = await getTodayRevenue();
            document.getElementById(
              "todayRevenue"
            ).textContent = "NT$ " + todayRevenue.toLocaleString();

            // è¼‰å…¥å•†å“ç¸½æ•¸
            const totalProducts = await getTotalProductsCount();
            document.getElementById("totalProducts").textContent =
              totalProducts;

            // è¼‰å…¥æœƒå“¡ç¸½æ•¸
            const totalCustomers = await getTotalCustomersCount();
            document.getElementById("totalCustomers").textContent =
              totalCustomers;
          } catch (error) {
            console.error("è¼‰å…¥æ§åˆ¶å°æ•¸æ“šå¤±æ•—:", error);
          }
        }

        // ç²å–ä»Šæ—¥è¨‚å–®æ•¸
        async function getTodayOrdersCount() {
          try {
            const today = new Date().toISOString().split("T")[0];
            console.log("ç²å–ä»Šæ—¥è¨‚å–®æ•¸ï¼Œæ—¥æœŸ:", today);
            
            // é¿å…ä½¿ç”¨ where æŸ¥è©¢ï¼Œç²å–æ‰€æœ‰è¨‚å–®å¾Œåœ¨å®¢æˆ¶ç«¯ç¯©é¸
            const snapshot = await firebase
              .firestore()
              .collection("orders")
              .get();
              
            let todayCount = 0;
            snapshot.forEach((doc) => {
              const order = doc.data();
              const orderDate = order.createdAt;
              
              if (orderDate && orderDate.startsWith(today)) {
                todayCount++;
              }
            });
            
            console.log("ä»Šæ—¥è¨‚å–®æ•¸:", todayCount);
            return todayCount;
          } catch (error) {
            console.error("ç²å–ä»Šæ—¥è¨‚å–®æ•¸å¤±æ•—:", error);
            console.error("éŒ¯èª¤è©³æƒ…:", error.message);
            return 0;
          }
        }

        // ç²å–ä»Šæ—¥ç‡Ÿæ¥­é¡
        async function getTodayRevenue() {
          try {
            const today = new Date().toISOString().split("T")[0];
            console.log("ç²å–ä»Šæ—¥ç‡Ÿæ¥­é¡ï¼Œæ—¥æœŸ:", today);
            
            // é¿å…è¤‡åˆæŸ¥è©¢ï¼Œå…ˆç²å–æ‰€æœ‰è¨‚å–®ï¼Œå†åœ¨å®¢æˆ¶ç«¯ç¯©é¸
            const snapshot = await firebase
              .firestore()
              .collection("orders")
              .get();

            let total = 0;
            let todayOrdersCount = 0;
            
            snapshot.forEach((doc) => {
              const order = doc.data();
              const orderDate = order.createdAt;
              
              // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šæ—¥è¨‚å–®ä¸”å·²ä»˜æ¬¾
              if (orderDate && orderDate.startsWith(today) && order.paymentStatus === "paid") {
                total += order.finalTotal || 0;
                todayOrdersCount++;
              }
            });
            
            // ä¿®æ­£èªæ³•éŒ¯èª¤ï¼šæ”¹ç”¨æ™®é€šå­—ä¸²ç›¸åŠ 
            console.log("ä»Šæ—¥ç‡Ÿæ¥­é¡: " + total + ", ä»Šæ—¥å·²ä»˜æ¬¾è¨‚å–®æ•¸: " + todayOrdersCount);
            return total;
          } catch (error) {
            console.error("ç²å–ä»Šæ—¥ç‡Ÿæ¥­é¡å¤±æ•—:", error);
            console.error("éŒ¯èª¤è©³æƒ…:", error.message);
            return 0;
          }
        }

        // ç²å–å•†å“ç¸½æ•¸
        async function getTotalProductsCount() {
          try {
            const snapshot = await firebase
              .firestore()
              .collection("products")
              .get();
            return snapshot.size;
          } catch (error) {
            console.error("ç²å–å•†å“ç¸½æ•¸å¤±æ•—:", error);
            return 0;
          }
        }

        // ç²å–æœƒå“¡ç¸½æ•¸
        async function getTotalCustomersCount() {
          try {
            const snapshot = await firebase
              .firestore()
              .collection("user")
              .get();
            return snapshot.size;
          } catch (error) {
            console.error("ç²å–æœƒå“¡ç¸½æ•¸å¤±æ•—:", error);
            return 0;
          }
        }

        // æ‰‹æ©Ÿç«¯é¸å–®åˆ‡æ›
        mobileMenuBtn.addEventListener("click", function () {
          sidebar.classList.toggle("mobile-shown");
          sidebarOverlay.classList.toggle("show");
        });

        sidebarOverlay.addEventListener("click", function () {
          sidebar.classList.remove("mobile-shown");
          sidebarOverlay.classList.remove("show");
        });

        // å°èˆªé¸å–®é»æ“Šäº‹ä»¶
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", function (e) {
            // å¦‚æœé€£çµæœ‰ href ä¸”ä¸æ˜¯ '#'ï¼Œå°±ç›´æ¥è·³è½‰
            const href = this.getAttribute("href");
            if (href && href !== "#") {
              return; // ä¸é˜»æ­¢é è¨­è¡Œç‚ºï¼Œè®“ç€è¦½å™¨æ­£å¸¸è·³è½‰
            }

            // å°æ–¼ä½¿ç”¨ data-page çš„å…§éƒ¨å°èˆªï¼Œæ‰é˜»æ­¢é è¨­è¡Œç‚º
            e.preventDefault();
            const page = this.dataset.page;

            // æ›´æ–°æ´»å‹•ç‹€æ…‹
            document
              .querySelectorAll(".nav-item")
              .forEach((nav) => nav.classList.remove("active"));
            this.classList.add("active");

            // é—œé–‰æ‰‹æ©Ÿç«¯é¸å–®
            sidebar.classList.remove("mobile-shown");
            sidebarOverlay.classList.remove("show");

            // è¼‰å…¥å°æ‡‰é é¢
            loadPage(page);
          });
        });

        // å¿«é€Ÿå‹•ä½œæŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.querySelectorAll(".action-btn").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            const page = this.dataset.page;

            // æ›´æ–°å°èˆªç‹€æ…‹
            document
              .querySelectorAll(".nav-item")
              .forEach((nav) => nav.classList.remove("active"));
            document
              .querySelector('[data-page="' + page + '"]')
              .classList.add("active");

            loadPage(page);
          });
        });

        // è¼‰å…¥ä¸åŒé é¢å…§å®¹
        function loadPage(page) {
          const pageTitles = {
            dashboard: "æ§åˆ¶å°",
            orders: "è¨‚å–®ç®¡ç†",
            products: "å•†å“ç®¡ç†",
            customers: "å®¢æˆ¶ç®¡ç†",
            reports: "ç‡Ÿæ¥­å ±è¡¨",
            finance: "è²¡å‹™ç®¡ç†",
            settings: "ç³»çµ±è¨­å®š",
            admins: "ç®¡ç†å“¡ç®¡ç†",
          };

          pageTitle.textContent = pageTitles[page] || "æ§åˆ¶å°";

          if (page === "dashboard") {
            dashboardContent.style.display = "block";
            dynamicContent.style.display = "none";
            loadDashboardData();
          } else if (page === "orders") {
            // ç›´æ¥è·³è½‰åˆ°è¨‚å–®ç®¡ç†é é¢
            window.location.href = "admin-orders.html";
          } else if (page === "products") {
            // ç›´æ¥è·³è½‰åˆ°å•†å“ç®¡ç†é é¢
            window.location.href = "admin-products.html";
          } else {
            dashboardContent.style.display = "none";
            dynamicContent.style.display = "block";

            // è¼‰å…¥å°æ‡‰çš„é é¢å…§å®¹
            loadDynamicPage(page, pageTitles[page]);
          }
        }

        // è¼‰å…¥å‹•æ…‹é é¢å…§å®¹
        function loadDynamicPage(page, title) {
          // æ ¹æ“šä¸åŒé é¢è¼‰å…¥ä¸åŒå…§å®¹
          switch (page) {
            case "products":
              loadProductsPage();
              break;
            case "customers":
              loadCustomersPage();
              break;
            case "reports":
              loadReportsPage();
              break;
            case "finance":
              loadFinancePage();
              break;
            case "settings":
              loadSettingsPage();
              break;
            case "admins":
              loadAdminsPage();
              break;
            default:
              // é¡¯ç¤ºé–‹ç™¼ä¸­é é¢
              dynamicContent.innerHTML = 
              '<div style="text-align: center; padding: 60px 20px;">' +
                '<i class="fas fa-tools" style="font-size: 64px; color: #bdc3c7; margin-bottom: 20px;"></i>' +
                '<h2 style="color: #7f8c8d; margin-bottom: 10px;">' + title + '</h2>' +
                '<p style="color: #95a5a6;">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
              '</div>';
          }
        }

        // å•†å“ç®¡ç†é é¢
        function loadProductsPage() {
          dynamicContent.innerHTML = 
          '<div style="text-align: center; padding: 60px 20px;">' +
            '<i class="fas fa-box" style="font-size: 64px; color: #f39c12; margin-bottom: 20px;"></i>' +
            '<h2 style="color: #7f8c8d; margin-bottom: 10px;">å•†å“ç®¡ç†</h2>' +
            '<p style="color: #95a5a6; margin-bottom: 20px;">å•†å“ç®¡ç†åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
            '<div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto; text-align: left;">' +
              '<h4 style="margin-bottom: 15px; color: #2c3e50;">é è¨ˆåŠŸèƒ½ï¼š</h4>' +
              '<ul style="color: #666; line-height: 1.6;">' +
                '<li>âœ… å•†å“åˆ—è¡¨ç®¡ç†</li>' +
                '<li>âœ… æ–°å¢/ç·¨è¼¯å•†å“</li>' +
                '<li>âœ… åº«å­˜ç®¡ç†</li>' +
                '<li>âœ… åˆ†é¡ç®¡ç†</li>' +
                '<li>âœ… å³æ™‚åº«å­˜è­¦å‘Š</li>' +
                '<li>âœ… å­£ç¯€æ€§å•†å“ç®¡ç†</li>' +
              '</ul>' +
            '</div>' +
          '</div>';
        }

        // å®¢æˆ¶ç®¡ç†é é¢
        function loadCustomersPage() {
          dynamicContent.innerHTML = 
          '<div style="text-align: center; padding: 60px 20px;">' +
            '<i class="fas fa-users" style="font-size: 64px; color: #3498db; margin-bottom: 20px;"></i>' +
            '<h2 style="color: #7f8c8d; margin-bottom: 10px;">å®¢æˆ¶ç®¡ç†</h2>' +
            '<p style="color: #95a5a6; margin-bottom: 20px;">å®¢æˆ¶ç®¡ç†åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
            '<div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto; text-align: left;">' +
              '<h4 style="margin-bottom: 15px; color: #2c3e50;">é è¨ˆåŠŸèƒ½ï¼š</h4>' +
              '<ul style="color: #666; line-height: 1.6;">' +
                '<li>âœ… å®¢æˆ¶åˆ—è¡¨æŸ¥çœ‹</li>' +
                '<li>âœ… è³¼è²·æ­·å²åˆ†æ</li>' +
                '<li>âœ… æœƒå“¡ç­‰ç´šç®¡ç†</li>' +
                '<li>âœ… å®¢æˆ¶åå¥½åˆ†æ</li>' +
                '<li>âœ… å®¢æˆ¶æ¨™ç±¤ç³»çµ±</li>' +
              '</ul>' +
            '</div>' +
          '</div>';
        }

        // ç‡Ÿæ¥­å ±è¡¨é é¢
        function loadReportsPage() {
          dynamicContent.innerHTML = 
          '<div style="text-align: center; padding: 60px 20px;">' +
            '<i class="fas fa-chart-bar" style="font-size: 64px; color: #9b59b6; margin-bottom: 20px;"></i>' +
            '<h2 style="color: #7f8c8d; margin-bottom: 10px;">ç‡Ÿæ¥­å ±è¡¨</h2>' +
            '<p style="color: #95a5a6; margin-bottom: 20px;">å ±è¡¨åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
            '<div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto; text-align: left;">' +
              '<h4 style="margin-bottom: 15px; color: #2c3e50;">é è¨ˆåŠŸèƒ½ï¼š</h4>' +
              '<ul style="color: #666; line-height: 1.6;">' +
                '<li>âœ… æ—¥å ±/é€±å ±/æœˆå ±</li>' +
                '<li>âœ… éŠ·å”®è¶¨å‹¢åˆ†æ</li>' +
                '<li>âœ… å•†å“éŠ·å”®æ’è¡Œ</li>' +
                '<li>âœ… å®¢æˆ¶æ¶ˆè²»åˆ†æ</li>' +
                '<li>âœ… åœ–è¡¨è¦–è¦ºåŒ–</li>' +
              '</ul>' +
            '</div>' +
          '</div>';
        }

        // è²¡å‹™ç®¡ç†é é¢
        function loadFinancePage() {
          dynamicContent.innerHTML = 
          '<div style="text-align: center; padding: 60px 20px;">' +
            '<i class="fas fa-dollar-sign" style="font-size: 64px; color: #27ae60; margin-bottom: 20px;"></i>' +
            '<h2 style="color: #7f8c8d; margin-bottom: 10px;">è²¡å‹™ç®¡ç†</h2>' +
            '<p style="color: #95a5a6; margin-bottom: 20px;">è²¡å‹™ç®¡ç†åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
            '<div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto; text-align: left;">' +
              '<h4 style="margin-bottom: 15px; color: #2c3e50;">é è¨ˆåŠŸèƒ½ï¼š</h4>' +
              '<ul style="color: #666; line-height: 1.6;">' +
                '<li>âœ… æ”¶å…¥çµ±è¨ˆ</li>' +
                '<li>âœ… é€€æ¬¾è™•ç†</li>' +
                '<li>âœ… å„ªæƒ åˆ¸ç®¡ç†</li>' +
                '<li>âœ… è²¡å‹™å ±è¡¨</li>' +
                '<li>âœ… å°å¸³åŠŸèƒ½</li>' +
              '</ul>' +
            '</div>' +
          '</div>';
        }

        // ç³»çµ±è¨­å®šé é¢
        function loadSettingsPage() {
          dynamicContent.innerHTML = 
          '<div style="text-align: center; padding: 60px 20px;">' +
            '<i class="fas fa-cog" style="font-size: 64px; color: #95a5a6; margin-bottom: 20px;"></i>' +
            '<h2 style="color: #7f8c8d; margin-bottom: 10px;">ç³»çµ±è¨­å®š</h2>' +
            '<p style="color: #95a5a6; margin-bottom: 20px;">ç³»çµ±è¨­å®šåŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
            '<div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto; text-align: left;">' +
              '<h4 style="margin-bottom: 15px; color: #2c3e50;">é è¨ˆåŠŸèƒ½ï¼š</h4>' +
              '<ul style="color: #666; line-height: 1.6;">' +
                '<li>âœ… åŸºæœ¬è¨­å®š</li>' +
                '<li>âœ… ä»˜æ¬¾è¨­å®š</li>' +
                '<li>âœ… ç‰©æµè¨­å®š</li>' +
                '<li>âœ… é€šçŸ¥è¨­å®š</li>' +
                '<li>âœ… è³‡æ–™å‚™ä»½</li>' +
              '</ul>' +
            '</div>' +
          '</div>';
        }

        // ç®¡ç†å“¡ç®¡ç†é é¢
        function loadAdminsPage() {
          dynamicContent.innerHTML = 
          '<div style="text-align: center; padding: 60px 20px;">' +
            '<i class="fas fa-user-shield" style="font-size: 64px; color: #e74c3c; margin-bottom: 20px;"></i>' +
            '<h2 style="color: #7f8c8d; margin-bottom: 10px;">ç®¡ç†å“¡ç®¡ç†</h2>' +
            '<p style="color: #95a5a6; margin-bottom: 20px;">ç®¡ç†å“¡ç®¡ç†åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>' +
            '<div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 0 auto; text-align: left;">' +
              '<h4 style="margin-bottom: 15px; color: #2c3e50;">é è¨ˆåŠŸèƒ½ï¼š</h4>' +
              '<ul style="color: #666; line-height: 1.6;">' +
                '<li>âœ… ç®¡ç†å“¡åˆ—è¡¨</li>' +
                '<li>âœ… æ–°å¢ç®¡ç†å“¡</li>' +
                '<li>âœ… æ¬Šé™è¨­å®š</li>' +
                '<li>âœ… æ“ä½œè¨˜éŒ„</li>' +
                '<li>âœ… è§’è‰²ç®¡ç†</li>' +
              '</ul>' +
            '</div>' +
          '</div>';
        }

                 // ç·¨è¼¯ç®¡ç†å“¡å§“å
         async function editAdminName(adminData) {
           const newName = prompt('è«‹è¼¸å…¥æ–°çš„ç®¡ç†å“¡å§“åï¼š', adminData.name);
           
           if (newName && newName.trim() && newName !== adminData.name) {
             try {
               // é©—è­‰ adminData.uid æ˜¯å¦å­˜åœ¨
               if (!adminData.uid) {
                 throw new Error('ç®¡ç†å“¡IDä¸å­˜åœ¨');
               }
               
               // é©—è­‰å§“åé•·åº¦
               if (newName.trim().length < 1 || newName.trim().length > 20) {
                 alert('å§“åé•·åº¦å¿…é ˆåœ¨1-20å€‹å­—ç¬¦ä¹‹é–“');
                 return;
               }
               
               // æ›´æ–° Firebase ä¸­çš„ç®¡ç†å“¡è³‡æ–™
               await firebase.firestore()
                 .collection('admins')
                 .doc(adminData.uid)
                 .update({
                   name: newName.trim(),
                   updatedAt: new Date().toISOString()
                 });
               
               // æ›´æ–°æœ¬åœ°é¡¯ç¤º
               adminData.name = newName.trim();
               updateAdminInfo(adminData);
               
               alert('ç®¡ç†å“¡å§“åæ›´æ–°æˆåŠŸï¼');
             } catch (error) {
               console.error('æ›´æ–°ç®¡ç†å“¡å§“åå¤±æ•—:', error);
               if (error.message === 'ç®¡ç†å“¡IDä¸å­˜åœ¨') {
                 alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥ç®¡ç†å“¡èº«ä»½ï¼Œè«‹é‡æ–°ç™»å…¥');
               } else {
                 alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
               }
             }
           }
         }

         // é¡¯ç¤ºé–‹ç™¼ä¸­é€šçŸ¥
         function showDevelopmentNotice() {
           alert('ğŸ”§ é€šçŸ¥åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­\n\næ­¤åŠŸèƒ½å°‡åŒ…å«ï¼š\nâ€¢ æ–°è¨‚å–®é€šçŸ¥\nâ€¢ åº«å­˜è­¦å‘Š\nâ€¢ ç³»çµ±æ›´æ–°\nâ€¢ é‡è¦è¨Šæ¯æé†’\n\næ•¬è«‹æœŸå¾…ï¼');
         }

                 // ç®¡ç†å“¡ç™»å‡ºåŠŸèƒ½
         document
           .getElementById("logoutBtn")
           .addEventListener("click", function () {
             const confirmLogout = confirm("ç¢ºå®šè¦ç™»å‡ºç®¡ç†å¾Œå°å—ï¼Ÿ");
             if (confirmLogout) {
               // é¡¯ç¤ºç™»å‡ºä¸­ç‹€æ…‹
               const logoutBtn = this;
               const originalTitle = logoutBtn.title;
               logoutBtn.title = 'ç™»å‡ºä¸­...';
               logoutBtn.style.opacity = '0.5';
               
               AuthService.signOut()
                 .then(() => {
                   window.location.href = "admin-login.html";
                 })
                 .catch((error) => {
                   console.error('ç™»å‡ºå¤±æ•—:', error);
                   alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                   // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                   logoutBtn.title = originalTitle;
                   logoutBtn.style.opacity = '1';
                 });
             }
           });
      });
    </script>
  </body>
</html>
