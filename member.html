<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>æœƒå“¡ä¸­å¿ƒ | éš±æ¹–å°ç«¹</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* æœƒå“¡ä¸­å¿ƒå°ˆç”¨æ¨£å¼ */
      body {
        background: #f8f9fa;
        margin: 0;
        padding: 0;
        font-family: "Noto Sans TC", sans-serif;
      }

      .member-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 100px;
      }

      /* é ‚éƒ¨å•å€™å€åŸŸ */
      .greeting-section {
        margin-bottom: 20px;
      }

      .greeting-text {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      /* æœƒå“¡å¡ç‰‡ */
      .member-card {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        color: white;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
      }

      .member-card-content {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .avatar-section {
        text-align: center;
      }

      .avatar {
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        font-size: 2rem;
        color: #ff6b6b;
      }

      .profile-link {
        font-size: 0.8rem;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .member-details {
        flex: 1;
      }

      .member-id {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 10px;
      }

      .member-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .stat-label {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stat-value {
        font-weight: 600;
        color: #fff;
      }

      .stat-arrow {
        color: rgba(255, 255, 255, 0.7);
      }

      /* é»æ•¸å…Œæ›å€åŸŸ */
      .points-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .points-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .points-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        margin: 0;
      }

      .see-more-link {
        color: #ff6b6b;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .points-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 20px;
        line-height: 1.4;
      }

      /* å•†å“å…Œæ›å€åŸŸ */
      .products-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .products-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-2px);
      }

      .product-image {
        position: relative;
        height: 120px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-placeholder {
        font-size: 2rem;
        color: #ccc;
      }

      .points-badge {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background: #ff6b6b;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .product-info {
        padding: 12px;
      }

      .product-name {
        font-size: 0.9rem;
        color: #333;
        margin: 0;
        line-height: 1.3;
      }

      /* æµ®å‹•å®¢æœæŒ‰éˆ• */
      .floating-service {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: #ff6b6b;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        z-index: 1000;
      }

      .service-icon {
        font-size: 1.2rem;
        margin-bottom: 2px;
      }

      .service-text {
        font-size: 0.7rem;
        font-weight: 500;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 480px) {
        .member-container {
          padding: 15px;
        }

        .member-stats {
          grid-template-columns: 1fr;
          gap: 8px;
        }

        .products-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="member-container">
      <!-- å•å€™å€åŸŸ -->
      <div class="greeting-section">
        <p class="greeting-text" id="greetingText">Hi, æ­¡è¿å›ä¾†ï¼</p>
      </div>

      <!-- æœƒå“¡å¡ç‰‡ -->
      <div class="member-card">
        <div class="member-card-content">
          <div class="avatar-section">
            <div class="avatar">ğŸ‘¤</div>
            <a href="#" class="profile-link">
              <span>æœƒå“¡æª”æ¡ˆ</span>
              <i class="fas fa-cog"></i>
            </a>
          </div>
          <div class="member-details">
            <div class="member-id" id="memberId">æœƒå“¡ç·¨è™Ÿ è¼‰å…¥ä¸­...</div>
            <div class="member-stats">
              <div class="stat-item">
                <div class="stat-label">
                  <span>å„ªæƒ åˆ¸</span>
                </div>
                <div class="stat-value">2</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
              <div class="stat-item">
                <div class="stat-label">
                  <span>é»æ•¸</span>
                  <i class="fas fa-star" style="color: #ffd700"></i>
                </div>
                <div class="stat-value" id="displayPoints">0</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
              <div class="stat-item">
                <div class="stat-label">
                  <span>éš¨é¥—åˆ¸</span>
                </div>
                <div class="stat-value">0</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
              <div class="stat-item">
                <div class="stat-label">
                  <span>å„²å€¼é‡‘</span>
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value">$0</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- é»æ•¸å…Œæ›å€åŸŸ -->
      <div class="points-section">
        <div class="points-header">
          <h2 class="points-title">é»æ•¸æ›ç¾å‘³</h2>
          <a href="#" class="see-more-link">çœ‹æ›´å¤š ></a>
        </div>
        <p class="points-description" id="pointsDescription">
          å†ç´¯ç© 30 é»å³å¯å…Œæ›ï¼š50é» - æ‹›ç‰ŒèŒ¶é£² + å°é»å¿ƒ
        </p>
      </div>

      <!-- å•†å“å…Œæ›å€åŸŸ -->
      <div class="products-section">
        <div class="products-grid">
          <div class="product-card" onclick="redeemProduct('tea', 20)">
            <div class="product-image">
              <div class="product-placeholder">ğŸµ</div>
              <div class="points-badge">20é»</div>
            </div>
            <div class="product-info">
              <h3 class="product-name">æ‹›ç‰ŒèŒ¶é£² (ä¸­)</h3>
            </div>
          </div>
          <div class="product-card" onclick="redeemProduct('noodles', 30)">
            <div class="product-image">
              <div class="product-placeholder">ğŸœ</div>
              <div class="points-badge">30é»</div>
            </div>
            <div class="product-info">
              <h3 class="product-name">æ‹›ç‰Œéºµé£Ÿ (å°)</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- æµ®å‹•å®¢æœæŒ‰éˆ• -->
      <a href="#" class="floating-service">
        <i class="fas fa-headset service-icon"></i>
        <span class="service-text">ç·šä¸Šå®¢æœ</span>
      </a>
    </main>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <div class="bottom-nav">
      <div class="nav-item" onclick="window.location.href='index.html'">
        <i class="fas fa-home"></i>
        <span>é¦–é </span>
      </div>
      <div class="nav-item" onclick="window.location.href='menu.html'">
        <i class="fas fa-utensils"></i>
        <span>èœå–®</span>
      </div>
      <div class="nav-item" onclick="window.location.href='order.html'">
        <i class="fas fa-shopping-cart"></i>
        <span>è¨‚é¤</span>
      </div>
      <div class="nav-item active" onclick="window.location.href='member.html'">
        <i class="fas fa-user"></i>
        <span>æœƒå“¡</span>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/services/auth.service.js"></script>
    <script src="js/services/user.service.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("æœƒå“¡ä¸­å¿ƒé é¢è¼‰å…¥å®Œæˆ");

        // æª¢æŸ¥ Firebase æ˜¯å¦æ­£ç¢ºåˆå§‹åŒ–
        console.log("æª¢æŸ¥ Firebase åˆå§‹åŒ–ç‹€æ…‹:");
        console.log("window.firebaseAuth:", window.firebaseAuth);
        console.log("window.firebaseDB:", window.firebaseDB);
        console.log("window.AuthService:", window.AuthService);
        console.log("window.UserService:", window.UserService);

        if (!window.AuthService) {
          console.error("AuthService æœªæ­£ç¢ºè¼‰å…¥ï¼");
          return;
        }

        console.log("ç­‰å¾… Auth ç‹€æ…‹å°±ç·’...");
        AuthService.onAuthStateChanged(async (user) => {
          console.log("Auth ç‹€æ…‹å°±ç·’ï¼Œç”¨æˆ¶:", user);

          if (!user) {
            console.log("æœªç™»å…¥ï¼Œå®‰å…¨è·³è½‰åˆ°ç™»å…¥é é¢");
            window.location.href = "login.html";
            return;
          }

          console.log("å·²ç™»å…¥ï¼Œä½¿ç”¨è€… ID:", user.uid);
          let userData = null;
          try {
            userData = await UserService.getUser(user.uid);
            console.log("å¾ Firestore ç²å–çš„è³‡æ–™:", userData);
          } catch (error) {
            console.error("ç²å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:", error);
          }

          // å¦‚æœæ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œå‰‡å˜—è©¦å¾ sessionStorage å‰µå»º
          if (!userData) {
            console.log(
              "Firestore ä¸­æ‰¾ä¸åˆ°ä½¿ç”¨è€…æ–‡ä»¶ï¼Œæ­£åœ¨æª¢æŸ¥ sessionStorage..."
            );
            const pendingDataJSON = sessionStorage.getItem("pending_user_data");
            console.log(
              "sessionStorage ä¸­çš„ pending_user_data:",
              pendingDataJSON
            );

            if (pendingDataJSON) {
              try {
                const pendingData = JSON.parse(pendingDataJSON);
                console.log("è§£æå¾Œçš„å¾…è™•ç†è³‡æ–™:", pendingData);

                if (pendingData.email === user.email) {
                  console.log(
                    "Email åŒ¹é…ï¼Œæ­£åœ¨å˜—è©¦å¾ sessionStorage çš„è³‡æ–™å»ºç«‹æ–‡ä»¶..."
                  );
                  await UserService.createUserDocument(user.uid, pendingData);
                  console.log("æ–‡ä»¶å»ºç«‹æˆåŠŸï¼Œæ­£åœ¨é‡æ–°ç²å–è³‡æ–™...");
                  userData = await UserService.getUser(user.uid);
                  console.log("é‡æ–°ç²å–åˆ°çš„è³‡æ–™:", userData);
                  sessionStorage.removeItem("pending_user_data");
                  console.log("å·²æ¸…é™¤ sessionStorage å‚™ä»½");
                } else {
                  console.log("Email ä¸åŒ¹é…ï¼Œæ¸…é™¤éæœŸè³‡æ–™");
                  sessionStorage.removeItem("pending_user_data");
                }
              } catch (error) {
                console.error("è™•ç† sessionStorage è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
              }
            }
          }

          // é¡¯ç¤ºç”¨æˆ¶è³‡æ–™
          console.log("æº–å‚™é¡¯ç¤ºè³‡æ–™ï¼ŒuserData:", userData);
          const displayName =
            userData?.name || user.email?.split("@")[0] || "æœƒå“¡";
          document.getElementById(
            "greetingText"
          ).textContent = `Hi, ${displayName}, æ­¡è¿å›ä¾†ï¼`;
          document.getElementById(
            "memberId"
          ).textContent = `æœƒå“¡ç·¨è™Ÿ ${user.uid.slice(-8)}`;
          document.getElementById("displayPoints").textContent =
            userData?.points ?? 0;

          // æ›´æ–°é»æ•¸æè¿°
          const currentPoints = userData?.points ?? 0;
          const nextReward = 50;
          const pointsNeeded = nextReward - currentPoints;
          if (pointsNeeded > 0) {
            document.getElementById(
              "pointsDescription"
            ).textContent = `å†ç´¯ç© ${pointsNeeded} é»å³å¯å…Œæ›ï¼š${nextReward}é» - æ‹›ç‰ŒèŒ¶é£² + å°é»å¿ƒ`;
          } else {
            document.getElementById(
              "pointsDescription"
            ).textContent = `æ­å–œï¼æ‚¨å·²å¯ä»¥å…Œæ›ï¼š${nextReward}é» - æ‹›ç‰ŒèŒ¶é£² + å°é»å¿ƒ`;
          }

          console.log("è³‡æ–™é¡¯ç¤ºå®Œæˆ");
        });
      });

      // é»æ•¸å…Œæ›åŠŸèƒ½æ¥å£
      function redeemProduct(productId, points) {
        console.log(`å…Œæ›å•†å“: ${productId}, éœ€è¦é»æ•¸: ${points}`);

        // TODO: å¯¦ç¾é»æ•¸å…Œæ›é‚è¼¯
        // 1. æª¢æŸ¥ç”¨æˆ¶é»æ•¸æ˜¯å¦è¶³å¤ 
        // 2. æ‰£é™¤é»æ•¸
        // 3. å°‡å•†å“åŠ å…¥è³¼ç‰©è»Š
        // 4. æ›´æ–°ç”¨æˆ¶è³‡æ–™

        alert(`å³å°‡å…Œæ›å•†å“ï¼Œéœ€è¦ ${points} é»`);

        // é€™è£¡å¯ä»¥èª¿ç”¨è³¼ç‰©è»Šæœå‹™
        // addToCartFromPoints(productId, points);
      }

      // è³¼ç‰©è»Šé€£å‹•æ¥å£
      function addToCartFromPoints(productId, points) {
        console.log(`å¾é»æ•¸å…Œæ›åŠ å…¥è³¼ç‰©è»Š: ${productId}`);

        // TODO: å¯¦ç¾è³¼ç‰©è»Šé€£å‹•
        // 1. æª¢æŸ¥é»æ•¸æ˜¯å¦è¶³å¤ 
        // 2. æ‰£é™¤é»æ•¸
        // 3. å°‡å•†å“åŠ å…¥è³¼ç‰©è»Š
        // 4. è·³è½‰åˆ°è³¼ç‰©è»Šé é¢

        // ç¤ºä¾‹ä»£ç¢¼ï¼š
        // if (checkPoints(points)) {
        //   deductPoints(points);
        //   addToCart(productId);
        //   window.location.href = 'order.html';
        // }
      }

      // é»æ•¸è¨ˆç®—æ¥å£
      function calculatePoints(orderAmount) {
        // TODO: å¯¦ç¾é»æ•¸è¨ˆç®—é‚è¼¯
        // é€šå¸¸æŒ‰ç…§æ¶ˆè²»é‡‘é¡è¨ˆç®—ï¼Œä¾‹å¦‚ï¼šæ¯æ¶ˆè²» 100 å…ƒç²å¾— 1 é»
        const pointsPerHundred = 1;
        return Math.floor(orderAmount / 100) * pointsPerHundred;
      }

      // æ›´æ–°ç”¨æˆ¶é»æ•¸æ¥å£
      async function updateUserPoints(userId, newPoints) {
        try {
          await UserService.updateUser(userId, { points: newPoints });
          console.log("é»æ•¸æ›´æ–°æˆåŠŸ");
        } catch (error) {
          console.error("é»æ•¸æ›´æ–°å¤±æ•—:", error);
        }
      }
    </script>
  </body>
</html>
