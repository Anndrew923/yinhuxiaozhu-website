<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>會員中心 | 隱湖小竹</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* 會員中心專用樣式 */
      body {
        background: #f8f9fa;
        margin: 0;
        padding: 0;
        font-family: "Noto Sans TC", sans-serif;
      }

      .member-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 100px;
      }

      /* 頂部問候區域 */
      .greeting-section {
        margin-bottom: 20px;
      }

      .greeting-text {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      /* 會員卡片 */
      .member-card {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        color: white;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
      }

      .member-card-content {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .avatar-section {
        text-align: center;
      }

      .avatar {
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        font-size: 2rem;
        color: #ff6b6b;
      }

      .profile-link {
        font-size: 0.8rem;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .member-details {
        flex: 1;
      }

      .member-id {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 10px;
      }

      .member-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .stat-label {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stat-value {
        font-weight: 600;
        color: #fff;
      }

      .stat-arrow {
        color: rgba(255, 255, 255, 0.7);
      }

      /* 點數兌換區域 */
      .points-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .points-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .points-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        margin: 0;
      }

      .see-more-link {
        color: #ff6b6b;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .points-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 20px;
        line-height: 1.4;
      }

      /* 商品兌換區域 */
      .products-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .products-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-2px);
      }

      .product-image {
        position: relative;
        height: 120px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-placeholder {
        font-size: 2rem;
        color: #ccc;
      }

      .points-badge {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background: #ff6b6b;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .product-info {
        padding: 12px;
      }

      .product-name {
        font-size: 0.9rem;
        color: #333;
        margin: 0;
        line-height: 1.3;
      }

      /* 浮動客服按鈕 */
      .floating-service {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: #ff6b6b;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        z-index: 1000;
      }

      .service-icon {
        font-size: 1.2rem;
        margin-bottom: 2px;
      }

      .service-text {
        font-size: 0.7rem;
        font-weight: 500;
      }

      /* 響應式設計 */
      @media (max-width: 480px) {
        .member-container {
          padding: 15px;
        }

        .member-stats {
          grid-template-columns: 1fr;
          gap: 8px;
        }

        .products-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="member-container">
      <!-- 問候區域 -->
      <div class="greeting-section">
        <p class="greeting-text" id="greetingText">Hi, 歡迎回來！</p>
      </div>

      <!-- 會員卡片 -->
      <div class="member-card">
        <div class="member-card-content">
          <div class="avatar-section">
            <div class="avatar">👤</div>
            <a href="#" class="profile-link">
              <span>會員檔案</span>
              <i class="fas fa-cog"></i>
            </a>
          </div>
          <div class="member-details">
            <div class="member-id" id="memberId">會員編號 載入中...</div>
            <div class="member-stats">
              <div class="stat-item">
                <div class="stat-label">
                  <span>優惠券</span>
                </div>
                <div class="stat-value">2</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
              <div class="stat-item">
                <div class="stat-label">
                  <span>點數</span>
                  <i class="fas fa-star" style="color: #ffd700"></i>
                </div>
                <div class="stat-value" id="displayPoints">0</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
              <div class="stat-item">
                <div class="stat-label">
                  <span>隨饗券</span>
                </div>
                <div class="stat-value">0</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
              <div class="stat-item">
                <div class="stat-label">
                  <span>儲值金</span>
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value">$0</div>
                <i class="fas fa-chevron-right stat-arrow"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 點數兌換區域 -->
      <div class="points-section">
        <div class="points-header">
          <h2 class="points-title">點數換美味</h2>
          <a href="#" class="see-more-link">看更多 ></a>
        </div>
        <p class="points-description" id="pointsDescription">
          再累積 30 點即可兌換：50點 - 招牌茶飲 + 小點心
        </p>
      </div>

      <!-- 商品兌換區域 -->
      <div class="products-section">
        <div class="products-grid">
          <div class="product-card" onclick="redeemProduct('tea', 20)">
            <div class="product-image">
              <div class="product-placeholder">🍵</div>
              <div class="points-badge">20點</div>
            </div>
            <div class="product-info">
              <h3 class="product-name">招牌茶飲 (中)</h3>
            </div>
          </div>
          <div class="product-card" onclick="redeemProduct('noodles', 30)">
            <div class="product-image">
              <div class="product-placeholder">🍜</div>
              <div class="points-badge">30點</div>
            </div>
            <div class="product-info">
              <h3 class="product-name">招牌麵食 (小)</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- 浮動客服按鈕 -->
      <a href="#" class="floating-service">
        <i class="fas fa-headset service-icon"></i>
        <span class="service-text">線上客服</span>
      </a>
    </main>

    <!-- 底部導覽列 -->
    <div class="bottom-nav">
      <div class="nav-item" onclick="window.location.href='index.html'">
        <i class="fas fa-home"></i>
        <span>首頁</span>
      </div>
      <div class="nav-item" onclick="window.location.href='menu.html'">
        <i class="fas fa-utensils"></i>
        <span>菜單</span>
      </div>
      <div class="nav-item" onclick="window.location.href='order.html'">
        <i class="fas fa-shopping-cart"></i>
        <span>訂餐</span>
      </div>
      <div class="nav-item active" onclick="window.location.href='member.html'">
        <i class="fas fa-user"></i>
        <span>會員</span>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/services/auth.service.js"></script>
    <script src="js/services/user.service.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("會員中心頁面載入完成");

        // 檢查 Firebase 是否正確初始化
        console.log("檢查 Firebase 初始化狀態:");
        console.log("window.firebaseAuth:", window.firebaseAuth);
        console.log("window.firebaseDB:", window.firebaseDB);
        console.log("window.AuthService:", window.AuthService);
        console.log("window.UserService:", window.UserService);

        if (!window.AuthService) {
          console.error("AuthService 未正確載入！");
          return;
        }

        console.log("等待 Auth 狀態就緒...");
        AuthService.onAuthStateChanged(async (user) => {
          console.log("Auth 狀態就緒，用戶:", user);

          if (!user) {
            console.log("未登入，安全跳轉到登入頁面");
            window.location.href = "login.html";
            return;
          }

          console.log("已登入，使用者 ID:", user.uid);
          let userData = null;
          try {
            userData = await UserService.getUser(user.uid);
            console.log("從 Firestore 獲取的資料:", userData);
          } catch (error) {
            console.error("獲取使用者資料失敗:", error);
          }

          // 如果找不到使用者資料，則嘗試從 sessionStorage 創建
          if (!userData) {
            console.log(
              "Firestore 中找不到使用者文件，正在檢查 sessionStorage..."
            );
            const pendingDataJSON = sessionStorage.getItem("pending_user_data");
            console.log(
              "sessionStorage 中的 pending_user_data:",
              pendingDataJSON
            );

            if (pendingDataJSON) {
              try {
                const pendingData = JSON.parse(pendingDataJSON);
                console.log("解析後的待處理資料:", pendingData);

                if (pendingData.email === user.email) {
                  console.log(
                    "Email 匹配，正在嘗試從 sessionStorage 的資料建立文件..."
                  );
                  await UserService.createUserDocument(user.uid, pendingData);
                  console.log("文件建立成功，正在重新獲取資料...");
                  userData = await UserService.getUser(user.uid);
                  console.log("重新獲取到的資料:", userData);
                  sessionStorage.removeItem("pending_user_data");
                  console.log("已清除 sessionStorage 備份");
                } else {
                  console.log("Email 不匹配，清除過期資料");
                  sessionStorage.removeItem("pending_user_data");
                }
              } catch (error) {
                console.error("處理 sessionStorage 資料時發生錯誤:", error);
              }
            }
          }

          // 顯示用戶資料
          console.log("準備顯示資料，userData:", userData);
          const displayName =
            userData?.name || user.email?.split("@")[0] || "會員";
          document.getElementById(
            "greetingText"
          ).textContent = `Hi, ${displayName}, 歡迎回來！`;
          document.getElementById(
            "memberId"
          ).textContent = `會員編號 ${user.uid.slice(-8)}`;
          document.getElementById("displayPoints").textContent =
            userData?.points ?? 0;

          // 更新點數描述
          const currentPoints = userData?.points ?? 0;
          const nextReward = 50;
          const pointsNeeded = nextReward - currentPoints;
          if (pointsNeeded > 0) {
            document.getElementById(
              "pointsDescription"
            ).textContent = `再累積 ${pointsNeeded} 點即可兌換：${nextReward}點 - 招牌茶飲 + 小點心`;
          } else {
            document.getElementById(
              "pointsDescription"
            ).textContent = `恭喜！您已可以兌換：${nextReward}點 - 招牌茶飲 + 小點心`;
          }

          console.log("資料顯示完成");
        });
      });

      // 點數兌換功能接口
      function redeemProduct(productId, points) {
        console.log(`兌換商品: ${productId}, 需要點數: ${points}`);

        // TODO: 實現點數兌換邏輯
        // 1. 檢查用戶點數是否足夠
        // 2. 扣除點數
        // 3. 將商品加入購物車
        // 4. 更新用戶資料

        alert(`即將兌換商品，需要 ${points} 點`);

        // 這裡可以調用購物車服務
        // addToCartFromPoints(productId, points);
      }

      // 購物車連動接口
      function addToCartFromPoints(productId, points) {
        console.log(`從點數兌換加入購物車: ${productId}`);

        // TODO: 實現購物車連動
        // 1. 檢查點數是否足夠
        // 2. 扣除點數
        // 3. 將商品加入購物車
        // 4. 跳轉到購物車頁面

        // 示例代碼：
        // if (checkPoints(points)) {
        //   deductPoints(points);
        //   addToCart(productId);
        //   window.location.href = 'order.html';
        // }
      }

      // 點數計算接口
      function calculatePoints(orderAmount) {
        // TODO: 實現點數計算邏輯
        // 通常按照消費金額計算，例如：每消費 100 元獲得 1 點
        const pointsPerHundred = 1;
        return Math.floor(orderAmount / 100) * pointsPerHundred;
      }

      // 更新用戶點數接口
      async function updateUserPoints(userId, newPoints) {
        try {
          await UserService.updateUser(userId, { points: newPoints });
          console.log("點數更新成功");
        } catch (error) {
          console.error("點數更新失敗:", error);
        }
      }
    </script>
  </body>
</html>
